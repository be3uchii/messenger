<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#ffffff">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{
            --primary:#2a7fff;--primary-hover:#1a6fee;--primary-light:#e8f1ff;
            --bg:#ffffff;--bg-secondary:#f5f6f8;--bg-input:#f0f2f5;--bg-hover:#eef0f3;
            --text:#1a1a1a;--text-secondary:#65676b;--text-muted:#8e8e93;--text-light:#b0b3b8;
            --border:#e4e6ea;--border-light:#f0f0f0;
            --white:#ffffff;--danger:#ff3b30;--success:#34c759;--warning:#ff9500;
            --shadow:0 1px 3px rgba(0,0,0,.08);--shadow-lg:0 4px 16px rgba(0,0,0,.12);
            --radius:10px;--radius-lg:14px;
        }
        html,body{height:100%;overflow:hidden;overscroll-behavior:none}
        body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);font-size:13px;line-height:1.4;overscroll-behavior-y:contain;touch-action:pan-x pan-y;-webkit-user-select:none;user-select:none}
        svg{display:inline-block;vertical-align:middle;fill:none;stroke:currentColor;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}

        .app{width:100%;height:100%;position:relative;overflow:hidden;background:var(--bg)}
        @media(min-width:768px){
            body{display:flex;align-items:center;justify-content:center;background:#e8ecf0}
            .app{width:420px;max-width:420px;height:90vh;max-height:780px;border-radius:18px;border:1px solid var(--border);box-shadow:0 8px 40px rgba(0,0,0,.12)}
        }
        @media(min-width:1200px){
            .app{width:440px;max-width:440px;height:92vh;max-height:820px;zoom:1.35}
        }
        @media(min-width:1600px){
            .app{width:460px;max-width:460px;height:94vh;max-height:860px;zoom:1.55}
        }

        .content,.edit-content,.messages,.dp-col{-webkit-user-select:text;user-select:text}
        input,textarea{-webkit-user-select:text;user-select:text}
        .screen{position:absolute;inset:0;display:flex;flex-direction:column;visibility:hidden;opacity:0;transition:opacity .2s,visibility .2s;will-change:opacity;pointer-events:none}
        .screen.active{visibility:visible;opacity:1;pointer-events:auto}

        .auth-screen{justify-content:center;align-items:center;padding:24px;background:linear-gradient(180deg,#f8faff 0%,#ffffff 100%)}
        .auth-wrap{width:100%;max-width:300px}
        .auth-logo{text-align:center;margin-bottom:32px}
        .auth-logo-icon{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,#4a9eff,#2a7fff);display:inline-flex;align-items:center;justify-content:center;margin-bottom:12px;box-shadow:0 4px 12px rgba(42,127,255,.3)}
        .auth-logo-icon svg{width:22px;height:22px;stroke:var(--white);stroke-width:2}
        .auth-logo h1{font-size:20px;font-weight:700;color:var(--text);letter-spacing:-.4px}
        .auth-logo p{color:var(--text-muted);font-size:11px;margin-top:4px}
        .auth-tabs{display:flex;background:var(--bg-input);border-radius:var(--radius);padding:3px;margin-bottom:20px}
        .auth-tab{flex:1;padding:7px;text-align:center;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;transition:all .25s;color:var(--text-muted)}
        .auth-tab.active{background:var(--white);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.08)}
        .auth-form{display:none}.auth-form.active{display:block;animation:fadeUp .25s ease}
        @keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
        .reg-name-row{display:flex;gap:8px}
        .reg-name-row .field{flex:1;margin-bottom:12px}
        .field{margin-bottom:12px}
        .field label{display:block;font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:5px;text-transform:uppercase;letter-spacing:.4px}
        .field-inner{position:relative}
        .field-inner svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;color:var(--text-light)}
        .field-inner input{width:100%;padding:9px 12px 9px 32px;background:var(--bg-input);border:1.5px solid transparent;border-radius:var(--radius);font-size:12px;color:var(--text);font-family:inherit;outline:none;transition:all .2s}
        .field-inner input::placeholder{color:var(--text-light)}
        .field-inner input:focus{border-color:var(--primary);background:var(--white);box-shadow:0 0 0 3px rgba(42,127,255,.1)}
        .field-inner input.field-error{border-color:var(--danger);background:var(--white);box-shadow:0 0 0 3px rgba(255,59,48,.08)}
        .field-hint{font-size:9px;color:var(--text-light);margin-top:4px}
        .field-hint.error{color:var(--danger)}
        .field-hint.success{color:var(--success)}
        .field-hint.checking{color:var(--text-muted)}
        .btn-primary{width:100%;padding:10px;border:none;border-radius:var(--radius);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;background:linear-gradient(135deg,#4a9eff,#2a7fff);color:var(--white);transition:all .2s;margin-top:6px;box-shadow:0 2px 8px rgba(42,127,255,.25)}
        .btn-primary:hover{box-shadow:0 4px 12px rgba(42,127,255,.35);transform:translateY(-1px)}
        .btn-primary:active{transform:scale(.98);box-shadow:0 1px 4px rgba(42,127,255,.2)}
        .btn-primary:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
        .auth-error{color:var(--danger);font-size:10px;text-align:center;margin-top:10px;min-height:14px;opacity:0;transition:opacity .2s}
        .auth-error.show{opacity:1}
        .auth-error.success{color:var(--success)}

        .toast{position:absolute;top:12px;left:50%;transform:translateX(-50%) translateY(-70px);padding:9px 18px;background:var(--text);color:var(--white);font-size:11px;font-weight:500;border-radius:var(--radius);box-shadow:var(--shadow-lg);z-index:100;transition:transform .35s cubic-bezier(.175,.885,.32,1.275);font-family:inherit;white-space:nowrap}
        .toast.show{transform:translateX(-50%) translateY(0)}
        .toast.toast-error{background:var(--danger)}
        .toast.toast-warning{background:var(--warning)}

        .topbar{padding:6px 14px;display:flex;align-items:center;justify-content:center;background:var(--bg);border-bottom:1px solid var(--border-light);min-height:40px}
        .topbar-title{font-size:14px;font-weight:700;color:var(--text);letter-spacing:-.2px}
        .icon-btn{width:32px;height:32px;border-radius:var(--radius);background:transparent;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;color:var(--text-secondary)}
        .icon-btn:hover{background:var(--bg-input)}
        .icon-btn:active{transform:scale(.92)}
        .icon-btn svg{width:18px;height:18px}

        .content{flex:1;overflow-y:auto;padding-bottom:44px;scrollbar-width:none}
        .content::-webkit-scrollbar{display:none}
        .tab-pane{display:none;animation:fadeUp .2s ease}.tab-pane.active{display:block}

        .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 30px;text-align:center}
        .empty-icon{width:48px;height:48px;border-radius:50%;background:var(--bg-input);display:flex;align-items:center;justify-content:center;margin-bottom:12px}
        .empty-icon svg{width:20px;height:20px;color:var(--text-light);stroke-width:1.5}
        .empty-title{font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px}
        .empty-desc{font-size:11px;color:var(--text-muted);line-height:1.5;max-width:200px}

        .search-wrap{padding:10px 14px}
        .search-box{position:relative}
        .search-box svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;color:var(--text-light)}
        .search-box input{width:100%;padding:8px 12px 8px 32px;background:var(--bg-input);border:none;border-radius:var(--radius);font-size:12px;color:var(--text);font-family:inherit;outline:none;transition:all .2s}
        .search-box input::placeholder{color:var(--text-light)}
        .search-box input:focus{box-shadow:0 0 0 2px rgba(42,127,255,.15);background:var(--white)}

        .search-results{padding:0 14px}
        .search-result-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:var(--radius);cursor:pointer;transition:background .15s}
        .search-result-item:hover{background:var(--bg-input)}
        .search-result-item:active{background:var(--bg-hover)}
        .sr-ava{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:13px;color:var(--white);background:linear-gradient(135deg,#4a9eff,#2a7fff);flex-shrink:0;overflow:hidden}
        .sr-ava img{width:100%;height:100%;object-fit:cover}
        .sr-info{flex:1;min-width:0}
        .sr-name{font-size:12px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .sr-sub{font-size:10px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
        .search-status{padding:20px;text-align:center;font-size:11px;color:var(--text-muted)}
        .search-status svg{display:block;margin:0 auto 8px;width:20px;height:20px;color:var(--text-light);stroke-width:1.5}

        .chat-list{padding:0 14px}
        .chat-item{display:flex;align-items:center;gap:9px;padding:8px;border-radius:var(--radius);cursor:pointer;transition:background .15s}
        .chat-item:hover{background:var(--bg-input)}
        .chat-item:active{background:var(--bg-hover)}
        .chat-item-ava{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;color:var(--white);background:linear-gradient(135deg,#4a9eff,#2a7fff);flex-shrink:0;overflow:hidden}
        .chat-item-ava img{width:100%;height:100%;object-fit:cover}
        .chat-item-info{flex:1;min-width:0}
        .chat-item-name{font-size:11px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .chat-item-last{font-size:10px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
        .chat-item-meta{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
        .chat-item-time{font-size:9px;color:var(--text-light)}
        .chat-item-badge{min-width:16px;height:16px;border-radius:8px;background:var(--primary);color:var(--white);font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 4px}

        .profile-sec{padding-bottom:8px}
        .profile-banner{height:100px;position:relative;overflow:hidden;background:linear-gradient(135deg,#4a9eff,#2a7fff,#1a6aee);background-size:200% 200%;animation:gMove 6s ease-in-out infinite}
        .profile-banner img{width:100%;height:100%;object-fit:cover}
        @keyframes gMove{0%,100%{background-position:0 50%}50%{background-position:100% 50%}}
        .profile-body{padding:0 16px;margin-top:-24px;position:relative;z-index:2}
        .profile-top{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:4px}
        .profile-ava{width:50px;height:50px;border-radius:50%;border:3px solid var(--bg);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:17px;color:var(--white);background:linear-gradient(135deg,#4a9eff,#2a7fff);box-shadow:0 2px 8px rgba(42,127,255,.2);overflow:hidden;flex-shrink:0;margin-left:-3px}
        .profile-ava img{width:100%;height:100%;object-fit:cover}
        .profile-btns{display:flex;gap:6px}
        .btn-outline{padding:5px 12px;border-radius:var(--radius);border:1.5px solid var(--border);background:var(--white);color:var(--text);font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
        .btn-outline:hover{background:var(--bg-input);border-color:var(--text-light)}
        .btn-outline:active{transform:scale(.97)}
        .profile-name{font-size:14px;font-weight:700;color:var(--text);letter-spacing:-.2px;padding-left:3px}
        .profile-stats{display:flex;justify-content:center;gap:0;padding:10px 0;border-top:1px solid var(--border-light);border-bottom:1px solid var(--border-light);margin:10px 0 0}
        .stat-item{flex:1;text-align:center}
        .stat-item+.stat-item{border-left:1px solid var(--border-light)}
        .stat-val{font-size:14px;font-weight:700;color:var(--text)}
        .stat-lbl{font-size:8px;color:var(--text-muted);margin-top:1px;text-transform:uppercase;letter-spacing:.4px}

        .info-section{padding:10px 16px}
        .info-header{font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:10px}
        .info-row{display:none;align-items:flex-start;gap:8px;margin-bottom:0}
        .info-row.visible{display:flex}
        .info-row.visible+.info-row.visible{margin-top:8px}
        .info-row svg{width:14px;height:14px;color:var(--primary);flex-shrink:0;margin-top:1px;opacity:.7}
        .info-label{font-size:9px;color:var(--text-muted);margin-bottom:1px}
        .info-value{font-size:11px;color:var(--text);line-height:1.4}
        .info-empty{font-size:10px;color:var(--text-light);font-style:italic}

        .section-divider{height:5px;background:var(--bg-secondary)}
        .logout-btn{display:block;width:calc(100% - 32px);margin:10px auto;padding:8px;border:none;border-radius:var(--radius);background:var(--bg-input);color:var(--danger);font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;text-align:center;transition:all .15s}
        .logout-btn:hover{background:#fff0f0}
        .logout-btn:active{transform:scale(.98)}

        .beta-notice{margin:8px 16px;padding:6px 10px;background:linear-gradient(135deg,#fff8e1,#fff3cd);border:1px solid #ffe082;border-radius:var(--radius);display:flex;align-items:flex-start;gap:6px}
        .beta-notice svg{width:12px;height:12px;color:#f59e0b;flex-shrink:0;margin-top:1px;stroke-width:2}
        .beta-notice-text{font-size:9px;color:#92700c;line-height:1.4}
        .beta-notice-title{font-weight:700;font-size:9px;color:#7c5e00}

        .bottom-nav{position:absolute;bottom:0;left:0;right:0;display:flex;align-items:center;justify-content:space-around;padding:3px 0;padding-bottom:max(3px,env(safe-area-inset-bottom));background:var(--bg);border-top:1px solid var(--border-light);z-index:20;min-height:44px}
        .nav-item{display:flex;flex-direction:column;align-items:center;gap:1px;cursor:pointer;padding:3px 20px;border-radius:10px;transition:all .2s;color:var(--text-light)}
        .nav-item.active{color:var(--primary)}
        .nav-item svg{width:18px;height:18px}
        .nav-item .nav-lbl{font-size:8px;font-weight:600}

        .chat-screen{position:absolute;inset:0;display:none;flex-direction:column;background:var(--bg);z-index:30;overflow:hidden}
        .chat-screen.active{display:flex;animation:slideIn .2s ease}
        @keyframes slideIn{from{transform:translateX(100%)}to{transform:none}}
        .chat-screen,.edit-screen{will-change:transform}
        .chat-header{padding:5px 10px;display:flex;align-items:center;gap:6px;background:var(--bg);border-bottom:1px solid var(--border-light);min-height:40px;flex-shrink:0;z-index:5}
        .chat-user{flex:1;display:flex;align-items:center;gap:7px}
        .chat-user-ava{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;color:var(--white);background:linear-gradient(135deg,#4a9eff,#2a7fff);overflow:hidden}
        .chat-user-ava img{width:100%;height:100%;object-fit:cover}
        .chat-user-name{font-size:11px;font-weight:600;color:var(--text)}
        .chat-user-status{font-size:8px;color:var(--text-light)}
        .messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:4px;scrollbar-width:none;background:var(--bg-secondary)}
        .messages::-webkit-scrollbar{display:none}
        .msg{max-width:75%;padding:8px 11px;border-radius:14px;font-size:12px;line-height:1.4}
        .msg.in{align-self:flex-start;background:var(--white);border:1px solid var(--border-light);border-bottom-left-radius:4px}
        .msg.out{align-self:flex-end;background:linear-gradient(135deg,#4a9eff,#2a7fff);color:var(--white);border-bottom-right-radius:4px}
        .msg-time{font-size:8px;margin-top:2px;text-align:right;opacity:.5}
        .chat-input-bar{padding:6px 10px;display:flex;align-items:center;gap:6px;background:var(--bg);border-top:1px solid var(--border-light);flex-shrink:0;z-index:5}
        .chat-input-bar input{flex:1;padding:8px 12px;background:var(--bg-input);border:none;border-radius:var(--radius);font-size:11px;color:var(--text);font-family:inherit;outline:none}
        .chat-input-bar input::placeholder{color:var(--text-light)}
        .send-btn{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#4a9eff,#2a7fff);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--white);flex-shrink:0;transition:all .15s;box-shadow:0 2px 6px rgba(42,127,255,.25)}
        .send-btn:hover{box-shadow:0 3px 10px rgba(42,127,255,.35)}
        .send-btn:active{transform:scale(.9)}
        .send-btn svg{width:13px;height:13px}

        .edit-screen{position:absolute;inset:0;display:none;flex-direction:column;background:var(--bg);z-index:30}
        .edit-screen.active{display:flex;animation:slideIn .25s ease}
        .edit-header{padding:5px 10px;display:flex;align-items:center;gap:6px;background:var(--bg);border-bottom:1px solid var(--border-light);min-height:40px}
        .edit-header-title{flex:1;font-size:13px;font-weight:700;color:var(--text);text-align:center;letter-spacing:-.2px}
        .edit-save{padding:5px 12px;border-radius:var(--radius);border:none;background:linear-gradient(135deg,#4a9eff,#2a7fff);color:var(--white);font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;box-shadow:0 2px 6px rgba(42,127,255,.2)}
        .edit-save:hover{box-shadow:0 3px 10px rgba(42,127,255,.3)}
        .edit-save:active{transform:scale(.97)}
        .edit-save:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
        .edit-content{flex:1;overflow-y:auto;scrollbar-width:none}
        .edit-content::-webkit-scrollbar{display:none}
        .edit-banner{height:110px;position:relative;overflow:hidden;background:linear-gradient(135deg,#4a9eff,#2a7fff,#1a6aee);cursor:pointer;transition:all .15s}
        .edit-banner:hover{opacity:.9}
        .edit-banner img{width:100%;height:100%;object-fit:cover}
        .edit-banner-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.2)}
        .edit-banner-overlay svg{width:22px;height:22px;color:var(--white);stroke-width:1.5}
        .edit-ava-wrap{display:flex;justify-content:center;margin-top:-30px;position:relative;z-index:2;margin-bottom:18px}
        .edit-ava{width:60px;height:60px;border-radius:50%;border:3px solid var(--bg);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;color:var(--white);background:linear-gradient(135deg,#4a9eff,#2a7fff);box-shadow:0 2px 10px rgba(42,127,255,.2);cursor:pointer;position:relative;overflow:hidden;transition:all .15s}
        .edit-ava:hover{opacity:.9}
        .edit-ava img{width:100%;height:100%;object-fit:cover}
        .edit-ava-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.25);border-radius:50%}
        .edit-ava-overlay svg{width:18px;height:18px;color:var(--white);stroke-width:1.5}
        .edit-fields{padding:0 16px 20px}
        .edit-field{margin-bottom:14px}
        .edit-field label{display:block;font-size:10px;font-weight:600;color:var(--text-muted);margin-bottom:5px;text-transform:uppercase;letter-spacing:.4px}
        .edit-field input,.edit-field textarea{width:100%;padding:9px 12px;background:var(--bg-input);border:1.5px solid transparent;border-radius:var(--radius);font-size:12px;color:var(--text);font-family:inherit;outline:none;transition:all .2s}
        .edit-field input::placeholder,.edit-field textarea::placeholder{color:var(--text-light)}
        .edit-field input:focus,.edit-field textarea:focus{border-color:var(--primary);background:var(--white);box-shadow:0 0 0 3px rgba(42,127,255,.1)}
        .edit-field input.field-error,.edit-field textarea.field-error{border-color:var(--danger);box-shadow:0 0 0 3px rgba(255,59,48,.08)}
        .edit-field textarea{resize:none;min-height:68px;line-height:1.5}
        .edit-field .field-hint{font-size:9px;color:var(--text-light);margin-top:4px}
        .edit-field .field-hint.error{color:var(--danger)}
        .edit-field .field-hint.success{color:var(--success)}
        .edit-field .field-hint.checking{color:var(--text-muted)}
        .edit-field input.field-success{border-color:var(--success);box-shadow:0 0 0 3px rgba(52,199,89,.08)}

        .username-field{position:relative}
        .username-field .at-prefix{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--text-muted);font-weight:500;pointer-events:none}
        .username-field input{padding-left:24px!important}

        .name-row{display:flex;gap:8px}
        .name-row .edit-field{flex:1}

        .edit-section-title{font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:14px;margin-top:6px;padding-top:14px;border-top:1px solid var(--border-light)}

        .date-picker-btn{width:100%;padding:9px 12px;background:var(--bg-input);border:1.5px solid transparent;border-radius:var(--radius);font-size:12px;color:var(--text);font-family:inherit;outline:none;cursor:pointer;transition:all .2s;text-align:left;display:flex;align-items:center;justify-content:space-between}
        .date-picker-btn:hover{background:var(--bg-hover)}
        .date-picker-btn .dp-text{color:var(--text)}
        .date-picker-btn .dp-placeholder{color:var(--text-light)}
        .date-picker-btn svg{width:14px;height:14px;color:var(--text-light);flex-shrink:0}

        .dp-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;display:none;align-items:flex-end;justify-content:center;opacity:0;transition:opacity .25s}
        .dp-overlay.show{display:flex;opacity:1}
        .dp-sheet{width:100%;max-width:420px;background:var(--bg);border-radius:16px 16px 0 0;transform:translateY(100%);transition:transform .3s cubic-bezier(.32,.72,0,1);overflow:hidden}
        .dp-overlay.show .dp-sheet{transform:translateY(0)}
        .dp-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border-light)}
        .dp-cancel{font-size:12px;color:var(--text-muted);font-weight:500;cursor:pointer;border:none;background:none;font-family:inherit;padding:4px 8px}
        .dp-cancel:hover{color:var(--text)}
        .dp-title{font-size:13px;font-weight:700;color:var(--text)}
        .dp-done{font-size:12px;color:var(--primary);font-weight:600;cursor:pointer;border:none;background:none;font-family:inherit;padding:4px 8px}
        .dp-done:hover{color:var(--primary-hover)}
        .dp-clear{font-size:11px;color:var(--danger);font-weight:500;cursor:pointer;border:none;background:none;font-family:inherit;padding:6px 16px;text-align:center;display:block;width:100%;border-top:1px solid var(--border-light)}
        .dp-clear:hover{background:var(--bg-input)}
        .dp-columns{display:flex;height:200px;position:relative;overflow:hidden}
        .dp-columns::before,.dp-columns::after{content:'';position:absolute;left:0;right:0;height:80px;z-index:3;pointer-events:none}
        .dp-columns::before{top:0;background:linear-gradient(180deg,rgba(255,255,255,.92) 0%,rgba(255,255,255,0) 100%)}
        .dp-columns::after{bottom:0;background:linear-gradient(0deg,rgba(255,255,255,.92) 0%,rgba(255,255,255,0) 100%)}
        .dp-highlight{position:absolute;left:8px;right:8px;top:50%;transform:translateY(-50%);height:36px;background:var(--bg-input);border-radius:8px;z-index:1;pointer-events:none}
        .dp-col{flex:1;overflow-y:auto;scrollbar-width:none;position:relative;z-index:2;-webkit-overflow-scrolling:touch;scroll-snap-type:y mandatory}
        .dp-col::-webkit-scrollbar{display:none}
        .dp-col-inner{padding:82px 0}
        .dp-item{height:36px;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--text-muted);cursor:pointer;scroll-snap-align:center;transition:all .15s;font-weight:400;user-select:none}
        .dp-item.selected{color:var(--text);font-weight:600}
        .dp-col:first-child .dp-item{padding-left:8px}
        .dp-col:last-child .dp-item{padding-right:8px}

        input[type="file"]{display:none}

        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:250;display:none;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
        .modal-overlay.show{display:flex;opacity:1}
        .modal-box{background:var(--bg);border-radius:var(--radius-lg);padding:20px;width:calc(100% - 48px);max-width:280px;text-align:center;transform:scale(.9);transition:transform .2s cubic-bezier(.175,.885,.32,1.275);box-shadow:0 12px 40px rgba(0,0,0,.2)}
        .modal-overlay.show .modal-box{transform:scale(1)}
        .modal-icon{width:44px;height:44px;border-radius:50%;background:#fff0f0;display:inline-flex;align-items:center;justify-content:center;margin-bottom:12px}
        .modal-icon svg{width:20px;height:20px;color:var(--danger);stroke-width:2}
        .modal-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px}
        .modal-desc{font-size:11px;color:var(--text-muted);line-height:1.5;margin-bottom:18px}
        .modal-btns{display:flex;gap:8px}
        .modal-btn{flex:1;padding:9px;border-radius:var(--radius);border:none;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
        .modal-btn:active{transform:scale(.97)}
        .modal-btn-cancel{background:var(--bg-input);color:var(--text)}
        .modal-btn-cancel:hover{background:var(--bg-hover)}
        .modal-btn-danger{background:var(--danger);color:var(--white)}
        .modal-btn-danger:hover{background:#e5342b}

        .fab{position:absolute;bottom:54px;right:14px;width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#4a9eff,#2a7fff);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--white);box-shadow:0 3px 12px rgba(42,127,255,.35);z-index:15;transition:all .2s}
        .fab:hover{box-shadow:0 4px 16px rgba(42,127,255,.45);transform:scale(1.05)}
        .fab:active{transform:scale(.92)}
        .fab svg{width:18px;height:18px;stroke-width:2}
        .create-post-screen{position:absolute;inset:0;display:none;flex-direction:column;background:var(--bg);z-index:30}
        .create-post-screen.active{display:flex;animation:slideIn .2s ease}
        .cp-header{padding:5px 10px;display:flex;align-items:center;gap:6px;background:var(--bg);border-bottom:1px solid var(--border-light);min-height:40px}
        .cp-header-title{flex:1;font-size:13px;font-weight:700;color:var(--text);text-align:center;letter-spacing:-.2px}
        .cp-publish{padding:5px 12px;border-radius:var(--radius);border:none;background:linear-gradient(135deg,#4a9eff,#2a7fff);color:var(--white);font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;box-shadow:0 2px 6px rgba(42,127,255,.2)}
        .cp-publish:disabled{opacity:.6;cursor:not-allowed}
        .cp-content{flex:1;overflow-y:auto;padding:14px 16px}
        .cp-textarea{width:100%;min-height:100px;padding:10px 12px;background:var(--bg-input);border:1.5px solid transparent;border-radius:var(--radius);font-size:12px;color:var(--text);font-family:inherit;outline:none;resize:none;line-height:1.5;transition:all .2s}
        .cp-textarea:focus{border-color:var(--primary);background:var(--white);box-shadow:0 0 0 3px rgba(42,127,255,.1)}
        .cp-textarea::placeholder{color:var(--text-light)}
        .cp-image-preview{margin-top:12px;position:relative;border-radius:var(--radius);overflow:hidden;display:none}
        .cp-image-preview img{width:100%;max-height:200px;object-fit:cover;border-radius:var(--radius)}
        .cp-image-remove{position:absolute;top:6px;right:6px;width:24px;height:24px;border-radius:50%;background:rgba(0,0,0,.6);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--white)}
        .cp-image-remove svg{width:12px;height:12px;stroke-width:2.5}
        .cp-actions{display:flex;gap:8px;margin-top:12px}
        .cp-action-btn{display:flex;align-items:center;gap:4px;padding:6px 10px;border-radius:var(--radius);border:1.5px solid var(--border);background:var(--white);color:var(--text-secondary);font-size:10px;font-weight:500;cursor:pointer;font-family:inherit;transition:all .15s}
        .cp-action-btn:hover{background:var(--bg-input)}
        .cp-action-btn svg{width:14px;height:14px}
        .cp-hint{font-size:9px;color:var(--text-light);margin-top:8px}
        .posts-list{padding:10px 14px 14px}
        .post-delete{width:20px;height:20px;border-radius:50%;background:transparent;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-light);transition:all .15s;flex-shrink:0;padding:0;position:absolute;top:10px;right:10px;z-index:2}
        .post-delete:hover{color:var(--danger)}
        .post-delete:active{transform:scale(.9)}
        .post-delete svg{width:12px;height:12px;stroke-width:2.5}
        .post-card{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:12px;margin-bottom:10px}
        .post-card{position:relative}
        .post-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding-right:24px}
        .verified-badge{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;flex-shrink:0;margin-left:1px;vertical-align:middle;position:relative;top:-1px}
        .verified-badge svg{width:14px;height:14px;fill:var(--primary);stroke:var(--white);stroke-width:2.5}
        .verified-sm{width:12px;height:12px;margin-left:2px}
        .verified-sm svg{width:12px;height:12px}
        .verified-lg{width:16px;height:16px;margin-left:3px}
        .verified-lg svg{width:16px;height:16px}
        .post-ava{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:10px;color:var(--white);background:linear-gradient(135deg,#4a9eff,#2a7fff);flex-shrink:0;overflow:hidden}
        .post-ava img{width:100%;height:100%;object-fit:cover}
        .post-author{flex:1;min-width:0}
        .post-author-name{font-size:11px;font-weight:600;color:var(--text)}
        .post-author-username{font-size:9px;color:var(--text-muted);display:inline}
        .post-time{font-size:9px;color:var(--text-light);display:inline;margin-left:4px}
        .post-author-meta{font-size:9px;color:var(--text-muted);margin-top:1px}
        .post-text{font-size:12px;color:var(--text);line-height:1.5;margin-bottom:6px;word-wrap:break-word}
        .post-image{width:100%;border-radius:var(--radius);overflow:hidden;margin-bottom:6px}
        .post-image img{width:100%;max-height:300px;object-fit:cover;display:block}
    </style>
</head>
<body>
<div class="app">
    <div class="toast" id="toast"></div>

    <div id="authScreen" class="screen auth-screen">
        <div class="auth-wrap">
            <div class="auth-logo">
                <div class="auth-logo-icon">
                    <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                </div>
                <h1>Messenger</h1>
                <p>Быстрый и простой обмен сообщениями</p>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="authTab('login')">Вход</div>
                <div class="auth-tab" onclick="authTab('register')">Регистрация</div>
            </div>
            <form id="loginForm" class="auth-form active" onsubmit="doLogin(event)">
                <div class="field">
                    <label>Email</label>
                    <div class="field-inner">
                        <svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="3"/><path d="M2 7l10 6 10-6"/></svg>
                        <input type="text" placeholder="your@email.com" id="loginEmail" autocomplete="email">
                    </div>
                </div>
                <div class="field">
                    <label>Пароль</label>
                    <div class="field-inner">
                        <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        <input type="password" placeholder="Введите пароль" id="loginPass" autocomplete="current-password">
                    </div>
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">Войти</button>
                <div class="auth-error" id="loginError"></div>
            </form>
            <form id="regForm" class="auth-form" onsubmit="doRegister(event)">
                <div class="reg-name-row">
                    <div class="field">
                        <label>Имя <span style="color:var(--danger)">*</span></label>
                        <div class="field-inner">
                            <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <input type="text" placeholder="3-12 букв" id="regName" maxlength="12">
                        </div>
                        <div class="field-hint" id="regNameHint"></div>
                    </div>
                    <div class="field">
                        <label>Фамилия</label>
                        <div class="field-inner">
                            <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <input type="text" placeholder="4-15 букв" id="regSurname" maxlength="15">
                        </div>
                        <div class="field-hint" id="regSurnameHint"></div>
                    </div>
                </div>
                <div class="field">
                    <label>Email <span style="color:var(--danger)">*</span></label>
                    <div class="field-inner">
                        <svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="3"/><path d="M2 7l10 6 10-6"/></svg>
                        <input type="text" placeholder="your@email.com" id="regEmail" autocomplete="email">
                    </div>
                    <div class="field-hint" id="regEmailHint"></div>
                </div>
                <div class="field">
                    <label>Пароль <span style="color:var(--danger)">*</span></label>
                    <div class="field-inner">
                        <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        <input type="password" placeholder="Минимум 6 символов" id="regPass" autocomplete="new-password">
                    </div>
                    <div class="field-hint" id="regPassHint"></div>
                </div>
                <button type="submit" class="btn-primary" id="regBtn">Создать аккаунт</button>
                <div class="auth-error" id="regError"></div>
            </form>
        </div>
    </div>

    <div id="mainScreen" class="screen main-screen">
        <div class="topbar">
            <div class="topbar-title" id="topTitle">Лента</div>
        </div>
        <div class="content">
            <div id="paneHome" class="tab-pane active">
                <div id="postsContainer" class="posts-list"></div>
                <div id="postsEmpty" class="empty-state">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    </div>
                    <div class="empty-title">Лента пуста</div>
                    <div class="empty-desc">Здесь будут появляться публикации</div>
                </div>
                <div id="postsLoading" class="search-status" style="display:none">Загрузка...</div>
            </div>
            <div id="paneChats" class="tab-pane">
                <div class="search-wrap">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <input type="text" placeholder="Поиск по ID или username..." id="chatSearchInput">
                    </div>
                </div>
                <div id="searchResults" class="search-results"></div>
                <div id="chatList" class="chat-list"></div>
                <div id="chatsLoading" class="search-status" style="display:none"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Загрузка чатов...</div>
                <div id="chatsEmptyState" class="empty-state" style="display:none">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                    </div>
                    <div class="empty-title">Нет сообщений</div>
                    <div class="empty-desc">Начните общение, найдя пользователя через поиск</div>
                </div>
            </div>
            <div id="paneProfile" class="tab-pane">
                <div class="profile-sec">
                    <div class="profile-banner" id="profileBanner"></div>
                    <div class="profile-body">
                        <div class="profile-top">
                            <div class="profile-ava" id="profileAva">U</div>
                            <div class="profile-btns">
                                <button class="btn-outline" onclick="openEdit()">Редактировать</button>
                            </div>
                        </div>
                        <div class="profile-name" id="profileName">Пользователь</div>
                        <div class="profile-stats">
                            <div class="stat-item"><div class="stat-val" id="postCount">0</div><div class="stat-lbl">Публикаций</div></div>
                            <div class="stat-item"><div class="stat-val">0</div><div class="stat-lbl">Подписчиков</div></div>
                            <div class="stat-item"><div class="stat-val">0</div><div class="stat-lbl">Подписок</div></div>
                        </div>
                    </div>
                    <div class="section-divider"></div>
                    <div class="info-section" id="infoSection">
                        <div class="info-header">Информация</div>
                        <div class="info-row" id="infoUsernameRow">
                            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 006 0v-1a10 10 0 10-3.92 7.94"/></svg>
                            <div>
                                <div class="info-value" id="infoUsernameText"></div>
                                <div class="info-label">Имя пользователя</div>
                            </div>
                        </div>
                        <div class="info-row" id="infoIdRow">
                            <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/><line x1="17" y1="11" x2="22" y2="11"/><line x1="17" y1="14" x2="22" y2="14"/></svg>
                            <div>
                                <div class="info-value" id="infoIdText" style="font-family:'SF Mono',Monaco,Consolas,monospace;letter-spacing:.5px"></div>
                                <div class="info-label">ID</div>
                            </div>
                        </div>
                        <div class="info-row" id="infoBioRow">
                            <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                            <div>
                                <div class="info-value" id="infoBioText"></div>
                                <div class="info-label">О себе</div>
                            </div>
                        </div>
                        <div class="info-row" id="infoBirthdayRow">
                            <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            <div>
                                <div class="info-value" id="infoBirthdayText"></div>
                                <div class="info-label">Дата рождения</div>
                            </div>
                        </div>
                        <div id="infoEmpty" class="info-empty">Информация не указана</div>
                    </div>
                    <div class="section-divider"></div>
                    <div class="beta-notice">
                        <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        <div class="beta-notice-text">
                            <div class="beta-notice-title">Бета-версия</div>
                            Приложение находится в разработке. Возможны ошибки и недоработки.
                        </div>
                    </div>
                    <button class="logout-btn" onclick="showLogoutModal()">Выйти из аккаунта</button>
                </div>
            </div>
        </div>
        <button class="fab" id="fabBtn" onclick="openCreatePost()">
            <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home',this)">
                <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span class="nav-lbl">Лента</span>
            </div>
            <div class="nav-item" onclick="switchTab('chats',this)">
                <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                <span class="nav-lbl">Чаты</span>
            </div>
            <div class="nav-item" onclick="switchTab('profile',this)">
                <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span class="nav-lbl">Профиль</span>
            </div>
        </nav>
    </div>

    <div id="chatScreen" class="chat-screen">
        <div class="chat-header">
            <div class="icon-btn" onclick="closeChat()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></div>
            <div class="chat-user">
                <div class="chat-user-ava" id="cAvatar">U</div>
                <div>
                    <div class="chat-user-name" id="cName">Пользователь</div>
                    <div class="chat-user-status">в сети</div>
                </div>
            </div>
            <div class="icon-btn"><svg viewBox="0 0 24 24"><circle cx="12" cy="5" r="1" fill="currentColor" stroke="none"/><circle cx="12" cy="12" r="1" fill="currentColor" stroke="none"/><circle cx="12" cy="19" r="1" fill="currentColor" stroke="none"/></svg></div>
        </div>
        <div class="messages" id="msgs">
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                </div>
                <div class="empty-title">Нет сообщений</div>
                <div class="empty-desc">Напишите первое сообщение, чтобы начать диалог</div>
            </div>
        </div>
        <div class="chat-input-bar">
            <div class="icon-btn"><svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></div>
            <input type="text" placeholder="Сообщение..." id="msgInput" onkeydown="if(event.key==='Enter')sendMessage()">
            <button class="send-btn" onclick="sendMessage()"><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
        </div>
    </div>

    <div id="editScreen" class="edit-screen">
        <div class="edit-header">
            <div class="icon-btn" onclick="closeEdit()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></div>
            <div class="edit-header-title">Редактирование</div>
            <button class="edit-save" id="editSaveBtn" onclick="saveProfile()">Сохранить</button>
        </div>
        <div class="edit-content">
            <div class="edit-banner" id="editBanner" onclick="document.getElementById('bannerInput').click()">
                <div class="edit-banner-overlay">
                    <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
                </div>
            </div>
            <input type="file" id="bannerInput" accept="image/*" onchange="previewBanner(event)">
            <div class="edit-ava-wrap">
                <div class="edit-ava" id="editAva" onclick="document.getElementById('avaInput').click()">
                    <span id="editAvaLetter">U</span>
                    <div class="edit-ava-overlay">
                        <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
                    </div>
                </div>
            </div>
            <input type="file" id="avaInput" accept="image/*" onchange="previewAva(event)">
            <div class="edit-fields">
                <div class="name-row">
                    <div class="edit-field">
                        <label>Имя <span style="color:var(--danger)">*</span></label>
                        <input type="text" id="editName" placeholder="От 3 до 12" maxlength="12">
                        <div class="field-hint" id="editNameHint"></div>
                    </div>
                    <div class="edit-field">
                        <label>Фамилия</label>
                        <input type="text" id="editSurname" placeholder="От 4 до 15" maxlength="15">
                        <div class="field-hint" id="editSurnameHint"></div>
                    </div>
                </div>
                <div class="edit-field">
                    <label>Имя пользователя</label>
                    <div class="username-field">
                        <span class="at-prefix">@</span>
                        <input type="text" id="editUsername" placeholder="username" maxlength="11">
                    </div>
                    <div class="field-hint" id="editUsernameHint">a-z, 0-9 и подчёркивания, от 5 до 11</div>
                </div>
                <div class="edit-section-title">Информация</div>
                <div class="edit-field">
                    <label>О себе</label>
                    <textarea id="editBio" placeholder="Расскажите о себе..." maxlength="40"></textarea>
                    <div class="field-hint" id="editBioHint"><span id="bioCounter">0</span>/40</div>
                </div>
                <div class="edit-field">
                    <label>Дата рождения</label>
                    <button type="button" class="date-picker-btn" id="datePickerBtn" onclick="openDatePicker()">
                        <span class="dp-placeholder" id="dpBtnText">Выберите дату</span>
                        <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    </button>
                    <div class="field-hint" id="editDateHint"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="createPostScreen" class="create-post-screen">
        <div class="cp-header">
            <div class="icon-btn" onclick="closeCreatePost()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></div>
            <div class="cp-header-title">Новая публикация</div>
            <button class="cp-publish" id="publishBtn" onclick="publishPost()">Опубликовать</button>
        </div>
        <div class="cp-content">
            <textarea class="cp-textarea" id="postText" placeholder="Что нового?" maxlength="500"></textarea>
            <div class="cp-image-preview" id="postImagePreview">
                <img id="postImagePreviewImg">
                <button class="cp-image-remove" onclick="removePostImage()"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="cp-actions">
                <button class="cp-action-btn" onclick="document.getElementById('postImageInput').click()">
                    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" stroke="none"/><polyline points="21 15 16 10 5 21"/></svg>
                    Фото
                </button>
            </div>
            <div class="cp-hint">Максимум 500 символов. Фото до 5 МБ.</div>
        </div>
        <input type="file" id="postImageInput" accept="image/*" onchange="previewPostImage(event)" style="display:none">
    </div>

    <div class="modal-overlay" id="logoutModal">
        <div class="modal-box">
            <div class="modal-icon">
                <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            </div>
            <div class="modal-title">Выйти из аккаунта?</div>
            <div class="modal-desc">Вы уверены, что хотите выйти? Для повторного входа потребуется ввести email и пароль.</div>
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeLogoutModal()">Отмена</button>
                <button class="modal-btn modal-btn-danger" id="confirmLogoutBtn" onclick="confirmLogout()">Выйти</button>
            </div>
        </div>
    </div>

    <div class="dp-overlay" id="dpOverlay" onclick="closeDatePicker(event)">
        <div class="dp-sheet" onclick="event.stopPropagation()">
            <div class="dp-header">
                <button class="dp-cancel" onclick="closeDatePicker()">Отмена</button>
                <div class="dp-title">Дата рождения</div>
                <button class="dp-done" onclick="confirmDate()">Готово</button>
            </div>
            <div class="dp-columns">
                <div class="dp-highlight"></div>
                <div class="dp-col" id="dpDay"><div class="dp-col-inner" id="dpDayInner"></div></div>
                <div class="dp-col" id="dpMonth"><div class="dp-col-inner" id="dpMonthInner"></div></div>
                <div class="dp-col" id="dpYear"><div class="dp-col-inner" id="dpYearInner"></div></div>
            </div>
            <button class="dp-clear" onclick="clearDate()">Очистить</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('keydown', function(e) {
    if ((e.key === 'F5') || (e.ctrlKey && e.key === 'r') || (e.metaKey && e.key === 'r')) { e.preventDefault(); }
    if (e.key === 'F12') { e.preventDefault(); return false; }
    if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j' || e.key === 'C' || e.key === 'c')) { e.preventDefault(); return false; }
    if (e.ctrlKey && (e.key === 'U' || e.key === 'u' || e.key === 'S' || e.key === 's')) { e.preventDefault(); return false; }
    if (e.metaKey && e.altKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j')) { e.preventDefault(); return false; }
    if (e.metaKey && (e.key === 'S' || e.key === 's' || e.key === 'U' || e.key === 'u')) { e.preventDefault(); return false; }
});
document.addEventListener('contextmenu', function(e) { e.preventDefault(); return false; });
document.addEventListener('dragstart', function(e) { e.preventDefault(); return false; });
document.addEventListener('drop', function(e) { e.preventDefault(); return false; });
(function() {
    var devtools = { open: false };
    var threshold = 160;
    setInterval(function() {
        if (window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold) {
            if (!devtools.open) { devtools.open = true; }
        } else { devtools.open = false; }
    }, 500);
})();
var _cl = console.log;
console.log = function() {};
console.warn = function() {};
console.error = function() {};
console.info = function() {};
console.debug = function() {};
console.table = function() {};
if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', function() {
        var cs = document.getElementById('chatScreen');
        if (cs && cs.classList.contains('active')) {
            cs.style.height = window.visualViewport.height + 'px';
            var msgs = document.getElementById('msgs');
            if (msgs) msgs.scrollTop = msgs.scrollHeight;
        }
    });
    window.visualViewport.addEventListener('scroll', function() {
        var cs = document.getElementById('chatScreen');
        if (cs && cs.classList.contains('active')) {
            cs.style.transform = 'translateY(' + window.visualViewport.offsetTop + 'px)';
        }
    });
}
document.getElementById('msgInput').addEventListener('focus', function() {
    var cs = document.getElementById('chatScreen');
    if (cs) cs.style.height = (window.visualViewport ? window.visualViewport.height : window.innerHeight) + 'px';
    setTimeout(function() {
        var msgs = document.getElementById('msgs');
        if (msgs) msgs.scrollTop = msgs.scrollHeight;
    }, 300);
});
document.getElementById('msgInput').addEventListener('blur', function() {
    var cs = document.getElementById('chatScreen');
    if (cs) { cs.style.height = ''; cs.style.transform = ''; }
});
window.addEventListener('beforeunload', function(e) {
    if (profile.id) { e.preventDefault(); e.returnValue = ''; }
});
document.addEventListener('touchmove', function(e) {
    if (e.touches.length > 1) e.preventDefault();
}, { passive: false });

var profileCache = {
    save: function() {
        try { localStorage.setItem('messenger-profile', JSON.stringify(profile)); } catch(e) {}
    },
    load: function() {
        try {
            var d = localStorage.getItem('messenger-profile');
            if (d) { var p = JSON.parse(d); if (p && p.id) return p; }
        } catch(e) {}
        return null;
    },
    clear: function() {
        try { localStorage.removeItem('messenger-profile'); } catch(e) {}
    }
};

var SUPABASE_URL = 'https://qpznkcgcbvmxskavrpxp.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwem5rY2djYnZteHNrYXZycHhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTE0NzAsImV4cCI6MjA4NTkyNzQ3MH0.cJhTZM8lrYiW-YucSBdUKchV2Dszd_yxE-aTT0aFJPg';
var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: {
        persistSession: true,
        storageKey: 'messenger-auth',
        storage: window.localStorage,
        autoRefreshToken: true,
        detectSessionInUrl: true
    }
});

var profile = {
    id: null, numeric_id: '', name: 'Пользователь', surname: '', username: '', bio: '',
    avatar_url: '', banner_url: '', birth_day: '', birth_month: '', birth_year: ''
};

var editSnapshot = null;
var pendingAvaFile = null;
var pendingBannerFile = null;
var monthNames = ['','Января','Февраля','Марта','Апреля','Мая','Июня','Июля','Августа','Сентября','Октября','Ноября','Декабря'];
var monthNamesShort = ['','Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];

var dpSelectedDay = 1;
var dpSelectedMonth = 1;
var dpSelectedYear = 2000;
var dpScrollTimeout = {};

function isValidEmail(e) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
function isOnlyLetters(s) { return /^[a-zA-Zа-яА-ЯёЁ]+$/.test(s); }
function isValidUsername(s) { return /^[a-z0-9_]+$/.test(s); }

function showToast(msg, type) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast' + (type === 'error' ? ' toast-error' : type === 'warning' ? ' toast-warning' : '') + ' show';
    clearTimeout(t._timer);
    t._timer = setTimeout(function() { t.classList.remove('show'); }, 3000);
}

function showAuthError(form, msg, isSuccess) {
    var el = document.getElementById(form + 'Error');
    el.textContent = msg;
    el.className = 'auth-error show' + (isSuccess ? ' success' : '');
}

function clearAuthErrors() {
    document.getElementById('loginError').className = 'auth-error';
    document.getElementById('regError').className = 'auth-error';
    clearFieldErrors('reg');
    clearFieldErrors('login');
}

function clearFieldErrors(prefix) {
    var hints = document.querySelectorAll('#' + prefix + 'Form .field-hint');
    hints.forEach(function(h) { h.textContent = ''; h.className = 'field-hint'; });
    var inputs = document.querySelectorAll('#' + prefix + 'Form .field-inner input');
    inputs.forEach(function(inp) { inp.classList.remove('field-error'); });
}

function setFieldError(id, hintId, msg) {
    var input = document.getElementById(id);
    var hint = document.getElementById(hintId);
    if (input) input.classList.add('field-error');
    if (hint) { hint.textContent = msg; hint.className = 'field-hint error'; }
}

function clearFieldError(id, hintId) {
    var input = document.getElementById(id);
    var hint = document.getElementById(hintId);
    if (input) input.classList.remove('field-error');
    if (hint) { hint.textContent = ''; hint.className = 'field-hint'; }
}

function translateError(msg) {
    var t = {
        'Invalid login credentials': 'Неверный email или пароль',
        'User already registered': 'Этот email уже зарегистрирован',
        'Password should be at least 6 characters': 'Пароль должен быть не менее 6 символов',
        'Unable to validate email address: invalid format': 'Некорректный формат email',
        'Email rate limit exceeded': 'Слишком много попыток, попробуйте позже',
        'For security purposes, you can only request this after 60 seconds': 'Подождите 60 секунд перед повторной попыткой',
        'Anonymous sign-ins are disabled': 'Заполните все обязательные поля',
        'Signup requires a valid password': 'Введите корректный пароль',
        'To signup, please provide your email': 'Укажите email для регистрации',
        'User not found': 'Пользователь не найден',
        'Email not confirmed': 'Email не подтверждён',
        'Invalid Refresh Token: Refresh Token Not Found': 'Сессия истекла, войдите заново',
        'New password should be different from the old password.': 'Новый пароль должен отличаться от старого',
        'Auth session missing!': 'Сессия не найдена, войдите заново',
        'over_email_send_rate_limit': 'Слишком много писем, подождите немного',
        'Database error saving new user': 'Ошибка при создании пользователя',
        'A user with this email address has already been registered': 'Этот email уже зарегистрирован',
        'Error sending confirmation email': 'Ошибка отправки письма подтверждения'
    };
    return t[msg] || msg;
}

function setLoading(btn, loading) {
    if (!btn) return;
    btn.disabled = loading;
    if (loading) { btn.dataset.orig = btn.textContent; btn.textContent = '...'; }
    else { btn.textContent = btn.dataset.orig || btn.textContent; }
}

function getDaysInMonth(month, year) {
    if (!month) return 31;
    month = parseInt(month);
    year = parseInt(year) || 2024;
    if (month === 2) {
        var leap = (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        return leap ? 29 : 28;
    }
    if ([4,6,9,11].indexOf(month) !== -1) return 30;
    return 31;
}

function buildDpColumn(container, items, selected, colKey) {
    container.innerHTML = '';
    items.forEach(function(item) {
        var div = document.createElement('div');
        div.className = 'dp-item' + (item.value === selected ? ' selected' : '');
        div.textContent = item.label;
        div.dataset.value = item.value;
        container.appendChild(div);
    });
}

function scrollToSelected(col, value) {
    var items = col.querySelectorAll('.dp-item');
    for (var i = 0; i < items.length; i++) {
        if (parseInt(items[i].dataset.value) === value) {
            col.scrollTop = items[i].offsetTop - col.offsetHeight / 2 + 18;
            break;
        }
    }
}

function getSelectedFromScroll(col) {
    var items = col.querySelectorAll('.dp-item');
    var center = col.scrollTop + col.offsetHeight / 2;
    var closest = null;
    var closestDist = Infinity;
    items.forEach(function(item) {
        var mid = item.offsetTop + 18;
        var dist = Math.abs(mid - center);
        if (dist < closestDist) { closestDist = dist; closest = item; }
    });
    return closest;
}

function updateDpSelection(col, colKey) {
    var selected = getSelectedFromScroll(col);
    if (!selected) return;
    var val = parseInt(selected.dataset.value);
    col.querySelectorAll('.dp-item').forEach(function(it) { it.classList.remove('selected'); });
    selected.classList.add('selected');
    if (colKey === 'day') dpSelectedDay = val;
    else if (colKey === 'month') { dpSelectedMonth = val; rebuildDays(); }
    else if (colKey === 'year') { dpSelectedYear = val; rebuildDays(); }
}

function rebuildDays() {
    var maxDays = getDaysInMonth(dpSelectedMonth, dpSelectedYear);
    if (dpSelectedDay > maxDays) dpSelectedDay = maxDays;
    var days = [];
    for (var d = 1; d <= maxDays; d++) days.push({ value: d, label: d });
    buildDpColumn(document.getElementById('dpDayInner'), days, dpSelectedDay, 'day');
    scrollToSelected(document.getElementById('dpDay'), dpSelectedDay);
}

function setupDpScroll(col, colKey) {
    col.addEventListener('scroll', function() {
        clearTimeout(dpScrollTimeout[colKey]);
        dpScrollTimeout[colKey] = setTimeout(function() {
            updateDpSelection(col, colKey);
            var selected = getSelectedFromScroll(col);
            if (selected) {
                col.scrollTo({ top: selected.offsetTop - col.offsetHeight / 2 + 18, behavior: 'smooth' });
            }
        }, 80);
    });
}

function openDatePicker() {
    if (profile.birth_day && profile.birth_month && profile.birth_year) {
        dpSelectedDay = parseInt(profile.birth_day);
        dpSelectedMonth = parseInt(profile.birth_month);
        dpSelectedYear = parseInt(profile.birth_year);
    } else {
        dpSelectedDay = 1;
        dpSelectedMonth = 1;
        dpSelectedYear = 2000;
    }

    var days = [];
    var maxDays = getDaysInMonth(dpSelectedMonth, dpSelectedYear);
    for (var d = 1; d <= maxDays; d++) days.push({ value: d, label: d });

    var months = [];
    for (var m = 1; m <= 12; m++) months.push({ value: m, label: monthNamesShort[m] });

    var years = [];
    for (var y = 1800; y <= 2026; y++) years.push({ value: y, label: y });

    buildDpColumn(document.getElementById('dpDayInner'), days, dpSelectedDay, 'day');
    buildDpColumn(document.getElementById('dpMonthInner'), months, dpSelectedMonth, 'month');
    buildDpColumn(document.getElementById('dpYearInner'), years, dpSelectedYear, 'year');

    var overlay = document.getElementById('dpOverlay');
    overlay.classList.add('show');

    setTimeout(function() {
        scrollToSelected(document.getElementById('dpDay'), dpSelectedDay);
        scrollToSelected(document.getElementById('dpMonth'), dpSelectedMonth);
        scrollToSelected(document.getElementById('dpYear'), dpSelectedYear);
    }, 50);
}

function closeDatePicker(e) {
    if (e && e.target !== document.getElementById('dpOverlay')) return;
    document.getElementById('dpOverlay').classList.remove('show');
}

function confirmDate() {
    profile.birth_day = dpSelectedDay;
    profile.birth_month = dpSelectedMonth;
    profile.birth_year = dpSelectedYear;
    updateDateBtn();
    closeDatePicker();
    var h = document.getElementById('editDateHint');
    h.textContent = '';
    h.className = 'field-hint';
}

function clearDate() {
    profile.birth_day = '';
    profile.birth_month = '';
    profile.birth_year = '';
    updateDateBtn();
    closeDatePicker();
}

function updateDateBtn() {
    var btn = document.getElementById('dpBtnText');
    if (profile.birth_day && profile.birth_month && profile.birth_year) {
        btn.textContent = profile.birth_day + ' ' + monthNames[parseInt(profile.birth_month)] + ' ' + profile.birth_year;
        btn.className = 'dp-text';
    } else {
        btn.textContent = 'Выберите дату';
        btn.className = 'dp-placeholder';
    }
}

function authTab(t) {
    clearAuthErrors();
    document.querySelectorAll('.auth-tab').forEach(function(el, i) {
        el.classList.toggle('active', (t === 'login' && i === 0) || (t === 'register' && i === 1));
    });
    document.getElementById('loginForm').classList.toggle('active', t === 'login');
    document.getElementById('regForm').classList.toggle('active', t === 'register');
}

function validateRegForm() {
    var valid = true;
    var name = document.getElementById('regName').value.trim();
    var surname = document.getElementById('regSurname').value.trim();
    var email = document.getElementById('regEmail').value.trim();
    var password = document.getElementById('regPass').value;
    clearFieldErrors('reg');
    if (!name) { setFieldError('regName', 'regNameHint', 'Имя обязательно'); valid = false; }
    else if (name.length < 3) { setFieldError('regName', 'regNameHint', 'Минимум 3 буквы'); valid = false; }
    else if (name.length > 12) { setFieldError('regName', 'regNameHint', 'Максимум 12 букв'); valid = false; }
    else if (!isOnlyLetters(name)) { setFieldError('regName', 'regNameHint', 'Только буквы'); valid = false; }
    if (surname) {
        if (surname.length < 4) { setFieldError('regSurname', 'regSurnameHint', 'Минимум 4 буквы'); valid = false; }
        else if (surname.length > 15) { setFieldError('regSurname', 'regSurnameHint', 'Максимум 15 букв'); valid = false; }
        else if (!isOnlyLetters(surname)) { setFieldError('regSurname', 'regSurnameHint', 'Только буквы'); valid = false; }
    }
    if (!email) { setFieldError('regEmail', 'regEmailHint', 'Email обязателен'); valid = false; }
    else if (!isValidEmail(email)) { setFieldError('regEmail', 'regEmailHint', 'Некорректный формат email'); valid = false; }
    if (!password) { setFieldError('regPass', 'regPassHint', 'Пароль обязателен'); valid = false; }
    else if (password.length < 6) { setFieldError('regPass', 'regPassHint', 'Минимум 6 символов'); valid = false; }
    else if (password.length > 72) { setFieldError('regPass', 'regPassHint', 'Максимум 72 символа'); valid = false; }
    return valid;
}

function validateLoginForm() {
    var valid = true;
    var email = document.getElementById('loginEmail').value.trim();
    var password = document.getElementById('loginPass').value;
    if (!email) { showAuthError('login', 'Введите email'); valid = false; }
    else if (!isValidEmail(email)) { showAuthError('login', 'Некорректный формат email'); valid = false; }
    else if (!password) { showAuthError('login', 'Введите пароль'); valid = false; }
    else if (password.length < 6) { showAuthError('login', 'Пароль не менее 6 символов'); valid = false; }
    return valid;
}

async function doRegister(e) {
    e.preventDefault();
    clearAuthErrors();
    if (!validateRegForm()) return;
    var btn = document.getElementById('regBtn');
    var name = document.getElementById('regName').value.trim();
    var surname = document.getElementById('regSurname').value.trim();
    var email = document.getElementById('regEmail').value.trim();
    var password = document.getElementById('regPass').value;
    setLoading(btn, true);
    try {
        var result = await sb.auth.signUp({ email: email, password: password, options: { data: { name: name, surname: surname } } });
        if (result.error) { showAuthError('reg', translateError(result.error.message)); setLoading(btn, false); return; }
        if (!result.data.user) { showAuthError('reg', 'Ошибка создания аккаунта'); setLoading(btn, false); return; }
        if (!result.data.session) { showAuthError('reg', 'Этот email уже зарегистрирован'); setLoading(btn, false); return; }
        await loadOrCreateProfile(result.data.user.id, name, surname);
        showMain();
    } catch (err) { showAuthError('reg', 'Ошибка соединения. Проверьте интернет'); }
    setLoading(btn, false);
}

async function doLogin(e) {
    e.preventDefault();
    clearAuthErrors();
    if (!validateLoginForm()) return;
    var btn = document.getElementById('loginBtn');
    var email = document.getElementById('loginEmail').value.trim();
    var password = document.getElementById('loginPass').value;
    setLoading(btn, true);
    try {
        var result = await sb.auth.signInWithPassword({ email: email, password: password });
        if (result.error) { showAuthError('login', translateError(result.error.message)); setLoading(btn, false); return; }
        if (!result.data.user || !result.data.session) { showAuthError('login', 'Ошибка авторизации'); setLoading(btn, false); return; }
        await loadOrCreateProfile(result.data.user.id, result.data.user.user_metadata?.name, result.data.user.user_metadata?.surname);
        showMain();
    } catch (err) { showAuthError('login', 'Ошибка соединения. Проверьте интернет'); }
    setLoading(btn, false);
}

function showLogoutModal() {
    document.getElementById('logoutModal').classList.add('show');
}

function closeLogoutModal() {
    document.getElementById('logoutModal').classList.remove('show');
}

async function confirmLogout() {
    var btn = document.getElementById('confirmLogoutBtn');
    btn.disabled = true;
    btn.textContent = '...';
    unsubscribeFromMessages();
    if (postsRefreshInterval) clearInterval(postsRefreshInterval);
    conversations = {};
    currentChatUserId = null;
    chatsLoaded = false;
    cachedPostsHtml = '';
    profileCache.clear();
    clearCachedConversations();
    try { await sb.auth.signOut(); } catch (err) {}
    profile = { id: null, numeric_id: '', name: 'Пользователь', surname: '', username: '', bio: '', avatar_url: '', banner_url: '', birth_day: '', birth_month: '', birth_year: '' };
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPass').value = '';
    document.getElementById('regName').value = '';
    document.getElementById('regSurname').value = '';
    document.getElementById('regEmail').value = '';
    document.getElementById('regPass').value = '';
    closeLogoutModal();
    btn.disabled = false;
    btn.textContent = 'Выйти';
    document.getElementById('mainScreen').classList.remove('active');
    setTimeout(function() {
        document.getElementById('authScreen').classList.add('active');
        switchTab('home', document.querySelector('.nav-item'));
    }, 60);
}

async function loadOrCreateProfile(userId, name, surname, useCache) {
    profile.id = userId;
    if (useCache) {
        var cached = profileCache.load();
        if (cached && cached.id === userId) {
            Object.assign(profile, cached);
            updateProfileUI();
            syncProfileInBackground(userId, name, surname);
            return;
        }
    }
    await fetchProfileFromServer(userId, name, surname);
}

async function generateUniqueNumericId() {
    for (var attempt = 0; attempt < 10; attempt++) {
        var id = '';
        for (var i = 0; i < 8; i++) id += Math.floor(Math.random() * 10);
        if (id.charAt(0) === '0') id = String(Math.floor(Math.random() * 9) + 1) + id.slice(1);
        var check = await sb.from('profiles').select('id').eq('numeric_id', id).maybeSingle();
        if (!check.data) return id;
    }
    return String(Math.floor(10000000 + Math.random() * 90000000));
}

async function ensureNumericId(userId) {
    try {
        var numId = await generateUniqueNumericId();
        await sb.from('profiles').update({ numeric_id: numId }).eq('id', userId).is('numeric_id', null);
        var res = await sb.from('profiles').select('numeric_id').eq('id', userId).maybeSingle();
        if (res.data) return res.data.numeric_id;
        return numId;
    } catch (err) { return ''; }
}

async function fetchProfileFromServer(userId, name, surname) {
    try {
        var upsertData = { id: userId, name: name || 'Пользователь' };
        if (surname) upsertData.surname = surname;
        await sb.from('profiles').upsert(upsertData, { onConflict: 'id', ignoreDuplicates: true });
        var result = await sb.from('profiles').select('*').eq('id', userId).maybeSingle();
        if (result.error) { profile.name = name || 'Пользователь'; profile.surname = surname || ''; }
        else if (result.data) {
            profile.name = result.data.name || 'Пользователь';
            profile.surname = result.data.surname || '';
            profile.username = result.data.username || '';
            profile.bio = result.data.bio || '';
            profile.avatar_url = result.data.avatar_url || '';
            profile.banner_url = result.data.banner_url || '';
            profile.birth_day = result.data.birth_day || '';
            profile.birth_month = result.data.birth_month || '';
            profile.birth_year = result.data.birth_year || '';
            profile.numeric_id = result.data.numeric_id || '';
            if (!profile.numeric_id) {
                profile.numeric_id = await ensureNumericId(userId);
            }
        } else { profile.name = name || 'Пользователь'; profile.surname = surname || ''; }
    } catch (err) { profile.name = name || 'Пользователь'; profile.surname = surname || ''; }
    profileCache.save();
    updateProfileUI();
}

function syncProfileInBackground(userId, name, surname) {
    fetchProfileFromServer(userId, name, surname);
}

function showMain() {
    document.getElementById('authScreen').classList.remove('active');
    setTimeout(function() { document.getElementById('mainScreen').classList.add('active'); loadConversations(); subscribeToMessages(); loadPosts(); startPostsAutoRefresh(); }, 60);
}

function switchTab(t, el) {
    document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
    el.classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(function(p) { p.classList.remove('active'); });
    var m = { home: 'paneHome', chats: 'paneChats', profile: 'paneProfile' };
    var titles = { home: 'Лента', chats: 'Чаты', profile: 'Профиль' };
    document.getElementById(m[t]).classList.add('active');
    document.getElementById('topTitle').textContent = titles[t];
    document.querySelector('.content').scrollTop = 0;
    var si = document.getElementById('chatSearchInput');
    if (si) si.value = '';
    var sr = document.getElementById('searchResults');
    if (sr) sr.innerHTML = '';
    lastSearchQuery = '';
    if (t === 'chats') renderChatList();
}

function closeChat() {
    currentChatUserId = null;
    var s = document.getElementById('chatScreen');
    s.style.transform = 'translateX(100%)';
    s.style.transition = 'transform .2s ease';
    setTimeout(function() { s.classList.remove('active'); s.style.transform = ''; s.style.transition = ''; }, 200);
    loadConversations();
}

function getEditSnapshot() {
    return JSON.stringify({
        name: document.getElementById('editName').value.trim(),
        surname: document.getElementById('editSurname').value.trim(),
        username: document.getElementById('editUsername').value.trim(),
        bio: document.getElementById('editBio').value.trim(),
        birth_day: profile.birth_day,
        birth_month: profile.birth_month,
        birth_year: profile.birth_year,
        avatar_url: profile.avatar_url,
        banner_url: profile.banner_url
    });
}

function openEdit() {
    document.getElementById('editName').value = profile.name;
    document.getElementById('editSurname').value = profile.surname;
    document.getElementById('editUsername').value = profile.username;
    document.getElementById('editBio').value = profile.bio;
    document.getElementById('bioCounter').textContent = profile.bio.length;
    updateDateBtn();
    clearEditErrors();

    var editBanner = document.getElementById('editBanner');
    var existingBannerImg = editBanner.querySelector('img');
    if (profile.banner_url) {
        if (!existingBannerImg) { var img = document.createElement('img'); img.src = profile.banner_url; editBanner.insertBefore(img, editBanner.firstChild); }
        else { existingBannerImg.src = profile.banner_url; }
    } else if (existingBannerImg) { existingBannerImg.remove(); }

    var editAva = document.getElementById('editAva');
    var existingAvaImg = editAva.querySelector('img');
    var avaLetter = document.getElementById('editAvaLetter');
    if (profile.avatar_url) {
        if (!existingAvaImg) { var img = document.createElement('img'); img.src = profile.avatar_url; editAva.insertBefore(img, editAva.firstChild); }
        else { existingAvaImg.src = profile.avatar_url; }
        avaLetter.style.display = 'none';
    } else {
        if (existingAvaImg) existingAvaImg.remove();
        avaLetter.style.display = '';
        avaLetter.textContent = profile.name.charAt(0).toUpperCase();
    }

    pendingAvaFile = null;
    pendingBannerFile = null;
    document.getElementById('avaInput').value = '';
    document.getElementById('bannerInput').value = '';
    document.getElementById('editScreen').classList.add('active');

    setTimeout(function() { editSnapshot = getEditSnapshot(); }, 50);
}

function clearEditErrors() {
    var hints = document.querySelectorAll('.edit-fields .field-hint');
    hints.forEach(function(h) {
        if (h.id === 'editBioHint') { h.className = 'field-hint'; h.innerHTML = '<span id="bioCounter">' + (document.getElementById('editBio').value || '').length + '</span>/40'; }
        else if (h.id === 'editUsernameHint') { h.className = 'field-hint'; h.textContent = 'a-z, 0-9 и подчёркивания, от 5 до 11'; }
        else if (h.id === 'editDateHint') { h.className = 'field-hint'; h.textContent = ''; }
        else { h.className = 'field-hint'; h.textContent = ''; }
    });
    var inputs = document.querySelectorAll('.edit-fields input, .edit-fields textarea');
    inputs.forEach(function(inp) { inp.classList.remove('field-error'); });
}

function closeEdit() {
    pendingAvaFile = null;
    pendingBannerFile = null;
    editSnapshot = null;
    var s = document.getElementById('editScreen');
    s.style.transform = 'translateX(100%)';
    s.style.transition = 'transform .2s ease';
    setTimeout(function() { s.classList.remove('active'); s.style.transform = ''; s.style.transition = ''; }, 200);
}

function previewBanner(e) {
    var file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { showToast('Выберите изображение', 'error'); return; }
    if (file.size > 5 * 1024 * 1024) { showToast('Максимум 5 МБ', 'error'); return; }
    pendingBannerFile = file;
    var reader = new FileReader();
    reader.onload = function(ev) {
        var banner = document.getElementById('editBanner');
        var existing = banner.querySelector('img');
        if (!existing) { var img = document.createElement('img'); img.src = ev.target.result; banner.insertBefore(img, banner.firstChild); }
        else { existing.src = ev.target.result; }
    };
    reader.onerror = function() { showToast('Ошибка чтения файла', 'error'); };
    reader.readAsDataURL(file);
}

function previewAva(e) {
    var file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { showToast('Выберите изображение', 'error'); return; }
    if (file.size > 2 * 1024 * 1024) { showToast('Максимум 2 МБ', 'error'); return; }
    pendingAvaFile = file;
    var reader = new FileReader();
    reader.onload = function(ev) {
        var ava = document.getElementById('editAva');
        var existing = ava.querySelector('img');
        var letter = document.getElementById('editAvaLetter');
        if (!existing) { var img = document.createElement('img'); img.src = ev.target.result; ava.insertBefore(img, ava.firstChild); }
        else { existing.src = ev.target.result; }
        letter.style.display = 'none';
    };
    reader.onerror = function() { showToast('Ошибка чтения файла', 'error'); };
    reader.readAsDataURL(file);
}

async function uploadImage(bucket, file) {
    try {
        var ext = file.name.split('.').pop() || 'jpg';
        var path = profile.id + '/' + bucket + '.' + ext;
        var res = await sb.storage.from(bucket).upload(path, file, { upsert: true, contentType: file.type });
        if (res.error) { showToast('Ошибка загрузки изображения', 'error'); return null; }
        var urlRes = sb.storage.from(bucket).getPublicUrl(path);
        return urlRes.data.publicUrl + '?t=' + Date.now();
    } catch (err) { showToast('Ошибка загрузки', 'error'); return null; }
}

function validateEditForm() {
    var valid = true;
    clearEditErrors();
    var name = document.getElementById('editName').value.trim();
    var surname = document.getElementById('editSurname').value.trim();
    var username = document.getElementById('editUsername').value.trim();
    var bio = document.getElementById('editBio').value.trim();

    if (!name) { document.getElementById('editName').classList.add('field-error'); var h = document.getElementById('editNameHint'); h.textContent = 'Имя обязательно'; h.className = 'field-hint error'; valid = false; }
    else if (name.length < 3) { document.getElementById('editName').classList.add('field-error'); var h = document.getElementById('editNameHint'); h.textContent = 'Минимум 3 буквы'; h.className = 'field-hint error'; valid = false; }
    else if (name.length > 12) { document.getElementById('editName').classList.add('field-error'); var h = document.getElementById('editNameHint'); h.textContent = 'Максимум 12 букв'; h.className = 'field-hint error'; valid = false; }
    else if (!isOnlyLetters(name)) { document.getElementById('editName').classList.add('field-error'); var h = document.getElementById('editNameHint'); h.textContent = 'Только буквы'; h.className = 'field-hint error'; valid = false; }

    if (surname) {
        if (surname.length < 4) { document.getElementById('editSurname').classList.add('field-error'); var h = document.getElementById('editSurnameHint'); h.textContent = 'Минимум 4 буквы'; h.className = 'field-hint error'; valid = false; }
        else if (surname.length > 15) { document.getElementById('editSurname').classList.add('field-error'); var h = document.getElementById('editSurnameHint'); h.textContent = 'Максимум 15 букв'; h.className = 'field-hint error'; valid = false; }
        else if (!isOnlyLetters(surname)) { document.getElementById('editSurname').classList.add('field-error'); var h = document.getElementById('editSurnameHint'); h.textContent = 'Только буквы'; h.className = 'field-hint error'; valid = false; }
    }

    if (!username && profile.username) {
        document.getElementById('editUsername').classList.add('field-error');
        var h = document.getElementById('editUsernameHint'); h.textContent = 'Нельзя удалить имя пользователя'; h.className = 'field-hint error'; valid = false;
    } else if (username) {
        if (username.length < 5) { document.getElementById('editUsername').classList.add('field-error'); var h = document.getElementById('editUsernameHint'); h.textContent = 'Минимум 5 символов'; h.className = 'field-hint error'; valid = false; }
        else if (username.length > 11) { document.getElementById('editUsername').classList.add('field-error'); var h = document.getElementById('editUsernameHint'); h.textContent = 'Максимум 11 символов'; h.className = 'field-hint error'; valid = false; }
        else if (!isValidUsername(username)) { document.getElementById('editUsername').classList.add('field-error'); var h = document.getElementById('editUsernameHint'); h.textContent = 'Только a-z, 0-9 и _'; h.className = 'field-hint error'; valid = false; }
        else if (/^[0-9_]/.test(username)) { document.getElementById('editUsername').classList.add('field-error'); var h = document.getElementById('editUsernameHint'); h.textContent = 'Должен начинаться с буквы'; h.className = 'field-hint error'; valid = false; }
        else if (/_{2,}/.test(username)) { document.getElementById('editUsername').classList.add('field-error'); var h = document.getElementById('editUsernameHint'); h.textContent = 'Нельзя два _ подряд'; h.className = 'field-hint error'; valid = false; }
        else if (username.endsWith('_')) { document.getElementById('editUsername').classList.add('field-error'); var h = document.getElementById('editUsernameHint'); h.textContent = 'Не может заканчиваться на _'; h.className = 'field-hint error'; valid = false; }
    }

    if (bio.length > 40) { document.getElementById('editBio').classList.add('field-error'); var h = document.getElementById('editBioHint'); h.innerHTML = '<span style="color:var(--danger)">' + bio.length + '/40</span>'; h.className = 'field-hint error'; valid = false; }

    if (profile.birth_day && profile.birth_month && profile.birth_year) {
        var y = parseInt(profile.birth_year);
        var now = new Date();
        var selectedDate = new Date(y, parseInt(profile.birth_month) - 1, parseInt(profile.birth_day));
        if (selectedDate > now) { var h = document.getElementById('editDateHint'); h.textContent = 'Дата не может быть в будущем'; h.className = 'field-hint error'; valid = false; }
    }

    return valid;
}

async function saveProfile() {
    if (!validateEditForm()) return;
    var name = document.getElementById('editName').value.trim();
    var surname = document.getElementById('editSurname').value.trim();
    var username = document.getElementById('editUsername').value.trim().replace(/[^a-zA-Z0-9_]/g, '');
    var bio = document.getElementById('editBio').value.trim();
    var btn = document.getElementById('editSaveBtn');

    var currentSnapshot = getEditSnapshot();
    var hasFileChanges = pendingAvaFile || pendingBannerFile;
    if (!hasFileChanges && editSnapshot && currentSnapshot === editSnapshot) {
        closeEdit();
        return;
    }

    setLoading(btn, true);
    try {
        var sessionCheck = await sb.auth.getSession();
        if (!sessionCheck.data.session) {
            showToast('Сессия истекла, войдите заново', 'error');
            profileCache.clear();
            profile = { id: null, numeric_id: '', name: 'Пользователь', surname: '', username: '', bio: '', avatar_url: '', banner_url: '', birth_day: '', birth_month: '', birth_year: '' };
            document.getElementById('editScreen').classList.remove('active');
            document.getElementById('mainScreen').classList.remove('active');
            document.getElementById('authScreen').classList.add('active');
            setLoading(btn, false); return;
        }
        if (username && username !== profile.username) {
            var check = await sb.from('profiles').select('id').eq('username', username).neq('id', profile.id).maybeSingle();
            if (check.data) {
                document.getElementById('editUsername').classList.add('field-error');
                var h = document.getElementById('editUsernameHint'); h.textContent = 'Это имя пользователя уже занято'; h.className = 'field-hint error';
                setLoading(btn, false); return;
            }
        }
        if (pendingAvaFile) { var url = await uploadImage('avatars', pendingAvaFile); if (url) profile.avatar_url = url; pendingAvaFile = null; }
        if (pendingBannerFile) { var url = await uploadImage('banners', pendingBannerFile); if (url) profile.banner_url = url; pendingBannerFile = null; }
        if (username && username !== profile.username) {
            var recheck = await sb.from('profiles').select('id').eq('username', username).neq('id', profile.id).maybeSingle();
            if (recheck.data) {
                document.getElementById('editUsername').classList.add('field-error');
                var h = document.getElementById('editUsernameHint'); h.textContent = '@' + username + ' только что заняли'; h.className = 'field-hint error';
                setLoading(btn, false); return;
            }
        }
        profile.name = name;
        profile.surname = surname;
        profile.username = username;
        profile.bio = bio;
        var updateData = {
            name: profile.name, surname: profile.surname || null, username: profile.username || null, bio: profile.bio,
            avatar_url: profile.avatar_url, banner_url: profile.banner_url,
            birth_day: profile.birth_day ? parseInt(profile.birth_day) : null,
            birth_month: profile.birth_month ? parseInt(profile.birth_month) : null,
            birth_year: profile.birth_year ? parseInt(profile.birth_year) : null
        };
        var result = await sb.from('profiles').update(updateData).eq('id', profile.id);
        if (result.error) {
            if (result.error.code === '23505') {
                showToast('Имя пользователя уже занято', 'error');
                document.getElementById('editUsername').classList.add('field-error');
                var h = document.getElementById('editUsernameHint'); h.textContent = 'Это имя уже занято'; h.className = 'field-hint error';
            } else { showToast('Ошибка сохранения', 'error'); }
            setLoading(btn, false); return;
        }
        profileCache.save();
        updateProfileUI();
        closeEdit();
        showToast('Профиль сохранён');
    } catch (err) { showToast('Ошибка соединения. Проверьте интернет', 'error'); }
    setLoading(btn, false);
}

function updateProfileUI() {
    var fullName = profile.name;
    if (profile.surname) fullName += ' ' + profile.surname;
    document.getElementById('profileName').innerHTML = escapeHtml(fullName) + verifiedBadgeForId(profile.numeric_id, 'lg');
    var usernameRow = document.getElementById('infoUsernameRow');
    var usernameText = document.getElementById('infoUsernameText');
    if (profile.username) { usernameText.textContent = '@' + profile.username; usernameRow.classList.add('visible'); }
    else { usernameRow.classList.remove('visible'); }
    var idRow = document.getElementById('infoIdRow');
    var idText = document.getElementById('infoIdText');
    if (profile.numeric_id) { idText.textContent = profile.numeric_id; idRow.classList.add('visible'); }
    else { idRow.classList.remove('visible'); }
    var bioRow = document.getElementById('infoBioRow');
    var bioText = document.getElementById('infoBioText');
    if (profile.bio) { bioText.textContent = profile.bio; bioRow.classList.add('visible'); }
    else { bioRow.classList.remove('visible'); }
    var bdayRow = document.getElementById('infoBirthdayRow');
    var bdayText = document.getElementById('infoBirthdayText');
    if (profile.birth_day && profile.birth_month && profile.birth_year) {
        bdayText.textContent = profile.birth_day + ' ' + monthNames[parseInt(profile.birth_month)] + ' ' + profile.birth_year;
        bdayRow.classList.add('visible');
    } else { bdayRow.classList.remove('visible'); }
    var infoEmpty = document.getElementById('infoEmpty');
    var hasInfo = profile.username || profile.numeric_id || profile.bio || (profile.birth_day && profile.birth_month && profile.birth_year);
    if (hasInfo) { infoEmpty.style.display = 'none'; }
    else { infoEmpty.style.display = 'block'; }
    var profileAva = document.getElementById('profileAva');
    var existingImg = profileAva.querySelector('img');
    if (profile.avatar_url) {
        if (!existingImg) { var img = document.createElement('img'); img.src = profile.avatar_url; profileAva.textContent = ''; profileAva.appendChild(img); }
        else { existingImg.src = profile.avatar_url; }
    } else { if (existingImg) existingImg.remove(); profileAva.textContent = profile.name.charAt(0).toUpperCase(); }
    var profileBanner = document.getElementById('profileBanner');
    var existingBannerImg = profileBanner.querySelector('img');
    if (profile.banner_url) {
        if (!existingBannerImg) { var img = document.createElement('img'); img.src = profile.banner_url; profileBanner.appendChild(img); }
        else { existingBannerImg.src = profile.banner_url; }
    } else { if (existingBannerImg) existingBannerImg.remove(); }
}

var usernameCheckTimeout = null;
var lastCheckedUsername = '';

document.getElementById('editUsername').addEventListener('input', function() {
    this.value = this.value.toLowerCase().replace(/[^a-z0-9_]/g, '').slice(0, 11);
    var val = this.value.trim();
    var h = document.getElementById('editUsernameHint');
    var inp = this;
    clearTimeout(usernameCheckTimeout);
    inp.classList.remove('field-error', 'field-success');

    if (!val) {
        if (profile.username) {
            h.textContent = 'Нельзя удалить имя пользователя';
            h.className = 'field-hint error';
            inp.classList.add('field-error');
        } else {
            h.textContent = 'a-z, 0-9 и подчёркивания, от 5 до 11';
            h.className = 'field-hint';
        }
        lastCheckedUsername = '';
        return;
    }
    if (val.length < 5) {
        h.textContent = 'Минимум 5 символов';
        h.className = 'field-hint error';
        inp.classList.add('field-error');
        return;
    }
    if (!isValidUsername(val)) {
        h.textContent = 'Только a-z, 0-9 и _';
        h.className = 'field-hint error';
        inp.classList.add('field-error');
        return;
    }
    if (/^[0-9_]/.test(val)) {
        h.textContent = 'Должен начинаться с буквы';
        h.className = 'field-hint error';
        inp.classList.add('field-error');
        return;
    }
    if (/_{2,}/.test(val)) {
        h.textContent = 'Нельзя использовать два _ подряд';
        h.className = 'field-hint error';
        inp.classList.add('field-error');
        return;
    }
    if (val.endsWith('_')) {
        h.textContent = 'Не может заканчиваться на _';
        h.className = 'field-hint error';
        inp.classList.add('field-error');
        return;
    }
    if (val === profile.username) {
        h.textContent = 'Ваш текущий username';
        h.className = 'field-hint success';
        inp.classList.remove('field-error');
        inp.classList.add('field-success');
        return;
    }
    h.textContent = 'Проверяем...';
    h.className = 'field-hint checking';
    usernameCheckTimeout = setTimeout(async function() {
        if (inp.value.trim() !== val) return;
        try {
            var check = await sb.from('profiles').select('id').eq('username', val).maybeSingle();
            if (inp.value.trim() !== val) return;
            if (check.data) {
                h.textContent = '@' + val + ' уже занят';
                h.className = 'field-hint error';
                inp.classList.add('field-error');
                inp.classList.remove('field-success');
            } else {
                h.textContent = '@' + val + ' свободен';
                h.className = 'field-hint success';
                inp.classList.remove('field-error');
                inp.classList.add('field-success');
            }
            lastCheckedUsername = val;
        } catch (err) {
            h.textContent = 'Не удалось проверить';
            h.className = 'field-hint error';
        }
    }, 500);
});

document.getElementById('editName').addEventListener('input', function() {
    this.value = this.value.slice(0, 12);
    var val = this.value.trim();
    var h = document.getElementById('editNameHint');
    this.classList.remove('field-error');
    if (val && !isOnlyLetters(val)) {
        h.textContent = 'Только буквы';
        h.className = 'field-hint error';
        this.classList.add('field-error');
    } else if (val && val.length < 3) {
        h.textContent = 'Минимум 3 буквы';
        h.className = 'field-hint error';
    } else {
        h.textContent = '';
        h.className = 'field-hint';
    }
});

document.getElementById('editSurname').addEventListener('input', function() {
    this.value = this.value.slice(0, 15);
    var val = this.value.trim();
    var h = document.getElementById('editSurnameHint');
    this.classList.remove('field-error');
    if (val && !isOnlyLetters(val)) {
        h.textContent = 'Только буквы';
        h.className = 'field-hint error';
        this.classList.add('field-error');
    } else if (val && val.length < 4) {
        h.textContent = 'Минимум 4 буквы';
        h.className = 'field-hint error';
    } else {
        h.textContent = '';
        h.className = 'field-hint';
    }
});
document.getElementById('editBio').addEventListener('input', function() {
    var len = this.value.length;
    var counter = document.getElementById('bioCounter');
    if (counter) counter.textContent = len;
    if (len > 40) { this.value = this.value.slice(0, 40); document.getElementById('bioCounter').textContent = 40; }
});
document.getElementById('regName').addEventListener('input', function() {
    var val = this.value.trim();
    var h = document.getElementById('regNameHint');
    this.classList.remove('field-error');
    if (val && !isOnlyLetters(val)) { h.textContent = 'Только буквы'; h.className = 'field-hint error'; this.classList.add('field-error'); }
    else if (val && val.length < 3) { h.textContent = 'Минимум 3 буквы'; h.className = 'field-hint error'; }
    else { h.textContent = ''; h.className = 'field-hint'; }
});
document.getElementById('regSurname').addEventListener('input', function() {
    var val = this.value.trim();
    var h = document.getElementById('regSurnameHint');
    this.classList.remove('field-error');
    if (val && !isOnlyLetters(val)) { h.textContent = 'Только буквы'; h.className = 'field-hint error'; this.classList.add('field-error'); }
    else if (val && val.length < 4) { h.textContent = 'Минимум 4 буквы'; h.className = 'field-hint error'; }
    else { h.textContent = ''; h.className = 'field-hint'; }
});
document.getElementById('regEmail').addEventListener('input', function() {
    var val = this.value.trim();
    var h = document.getElementById('regEmailHint');
    this.classList.remove('field-error');
    if (val && !isValidEmail(val)) { h.textContent = 'Некорректный формат'; h.className = 'field-hint error'; }
    else { h.textContent = ''; h.className = 'field-hint'; }
});
document.getElementById('regPass').addEventListener('input', function() {
    var val = this.value;
    var h = document.getElementById('regPassHint');
    this.classList.remove('field-error');
    if (val && val.length < 6) { h.textContent = 'Минимум 6 символов'; h.className = 'field-hint error'; }
    else if (val && val.length > 72) { h.textContent = 'Максимум 72 символа'; h.className = 'field-hint error'; }
    else if (val && val.length >= 6) { h.textContent = ''; h.className = 'field-hint'; }
    else { h.textContent = ''; h.className = 'field-hint'; }
});
document.getElementById('loginEmail').addEventListener('input', function() { document.getElementById('loginError').className = 'auth-error'; });
document.getElementById('loginPass').addEventListener('input', function() { document.getElementById('loginError').className = 'auth-error'; });

setupDpScroll(document.getElementById('dpDay'), 'day');
setupDpScroll(document.getElementById('dpMonth'), 'month');
setupDpScroll(document.getElementById('dpYear'), 'year');

async function init() {
    var cached = profileCache.load();
    if (cached && cached.id) {
        Object.assign(profile, cached);
        updateProfileUI();
        document.getElementById('mainScreen').classList.add('active');
    } else {
        document.getElementById('authScreen').classList.add('active');
    }
    try {
        var result = await sb.auth.getSession();
        if (result.error) {
            if (cached) { profileCache.clear(); document.getElementById('mainScreen').classList.remove('active'); document.getElementById('authScreen').classList.add('active'); }
            return;
        }
        if (result.data.session) {
            var user = result.data.session.user;
            if (!user) { return; }
            if (cached && cached.id === user.id) {
                syncProfileInBackground(user.id, user.user_metadata?.name, user.user_metadata?.surname);
            } else {
                await loadOrCreateProfile(user.id, user.user_metadata?.name, user.user_metadata?.surname, false);
                document.getElementById('authScreen').classList.remove('active');
                document.getElementById('mainScreen').classList.add('active');
            }
        } else {
            if (cached) { profileCache.clear(); document.getElementById('mainScreen').classList.remove('active'); document.getElementById('authScreen').classList.add('active'); }
        }
    } catch (err) {
        if (!cached) { showToast('Ошибка загрузки. Проверьте интернет', 'error'); }
    }
    if (profile.id) { loadConversations(); subscribeToMessages(); }
}

sb.auth.onAuthStateChange(function(event, session) {
    if (event === 'TOKEN_REFRESHED' && session) {
        profile.id = session.user.id;
    }
    if (event === 'SIGNED_OUT') {
        profileCache.clear();
        profile = { id: null, numeric_id: '', name: 'Пользователь', surname: '', username: '', bio: '', avatar_url: '', banner_url: '', birth_day: '', birth_month: '', birth_year: '' };
        if (!document.getElementById('authScreen').classList.contains('active')) {
            document.getElementById('editScreen').classList.remove('active');
            document.getElementById('chatScreen').classList.remove('active');
            document.getElementById('mainScreen').classList.remove('active');
            document.getElementById('authScreen').classList.add('active');
        }
    }
    if (event === 'TOKEN_REFRESH_FAILED') {
        profileCache.clear();
        profile = { id: null, numeric_id: '', name: 'Пользователь', surname: '', username: '', bio: '', avatar_url: '', banner_url: '', birth_day: '', birth_month: '', birth_year: '' };
        document.getElementById('editScreen').classList.remove('active');
        document.getElementById('chatScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.remove('active');
        document.getElementById('authScreen').classList.add('active');
        showToast('Сессия истекла, войдите заново', 'warning');
    }
});

var searchTimeout = null;
var lastSearchQuery = '';

document.getElementById('chatSearchInput').addEventListener('input', function() {
    var query = this.value.trim().replace(/^@/, '');
    var resultsContainer = document.getElementById('searchResults');
    var emptyState = document.getElementById('chatsEmptyState');

    clearTimeout(searchTimeout);

    if (!query) {
        resultsContainer.innerHTML = '';
        lastSearchQuery = '';
        renderChatList();
        return;
    }

    if (query === lastSearchQuery) return;

    emptyState.style.display = 'none';
    resultsContainer.innerHTML = '<div class="search-status"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Поиск...</div>';

    searchTimeout = setTimeout(async function() {
        var input = document.getElementById('chatSearchInput');
        if (!input) return;
        var currentQuery = input.value.trim().replace(/^@/, '');
        if (currentQuery !== query) return;

        lastSearchQuery = query;

        try {
            var results = [];
            var isNumeric = /^\d+$/.test(query);

            if (isNumeric) {
                var res = await sb.from('profiles').select('id, name, surname, username, avatar_url, numeric_id').eq('numeric_id', query).limit(10);
                if (res.data && res.data.length > 0) {
                    results = res.data;
                } else {
                    var res2 = await sb.from('profiles').select('id, name, surname, username, avatar_url, numeric_id').like('numeric_id', query + '%').limit(10);
                    if (res2.data) results = res2.data;
                }
            } else {
                var res = await sb.from('profiles').select('id, name, surname, username, avatar_url, numeric_id').ilike('username', '%' + query + '%').limit(10);
                if (res.data) results = res.data;

                var res2 = await sb.from('profiles').select('id, name, surname, username, avatar_url, numeric_id').ilike('name', '%' + query + '%').limit(10);
                if (res2.data) {
                    res2.data.forEach(function(item) {
                        if (!results.find(function(r) { return r.id === item.id; })) {
                            results.push(item);
                        }
                    });
                }
            }

            results = results.filter(function(r) { return r.id !== profile.id && r.username; });

            var currentInput = document.getElementById('chatSearchInput');
            if (!currentInput || currentInput.value.trim().replace(/^@/, '') !== query) return;

            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="search-status"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></svg>Никого не найдено</div>';
                return;
            }

            var html = '';
            results.forEach(function(user) {
                var fullName = user.name || 'Пользователь';
                if (user.surname) fullName += ' ' + user.surname;
                var letter = (user.name || 'U').charAt(0).toUpperCase();
                var avaHtml = user.avatar_url
                    ? '<div class="sr-ava"><img src="' + user.avatar_url + '"></div>'
                    : '<div class="sr-ava">' + letter + '</div>';
                var subText = user.username ? '@' + user.username : 'ID: ' + (user.numeric_id || '');
                var searchVerified = verifiedBadgeForId(user.numeric_id, 'sm');
                html += '<div class="search-result-item" onclick="openChatWith(\'' + user.id + '\',\'' + fullName.replace(/'/g, "\\'") + '\',\'' + letter + '\',\'' + (user.avatar_url || '').replace(/'/g, "\\'") + '\')">'
                    + avaHtml
                    + '<div class="sr-info">'
                    + '<div class="sr-name">' + escapeHtml(fullName) + searchVerified + '</div>'
                    + '<div class="sr-sub">' + subText + '</div>'
                    + '</div></div>';
            });

            resultsContainer.innerHTML = html;

        } catch (err) {
            resultsContainer.innerHTML = '<div class="search-status">Ошибка поиска</div>';
        }
    }, 400);
});

var conversations = {};
var currentChatUserId = null;
var messagesChannel = null;

function formatMsgTime(ts) {
    var d = new Date(ts);
    var now = new Date();
    var h = d.getHours().toString().padStart(2,'0');
    var m = d.getMinutes().toString().padStart(2,'0');
    var time = h + ':' + m;
    if (d.toDateString() === now.toDateString()) return time;
    var y = new Date(now);
    y.setDate(y.getDate() - 1);
    if (d.toDateString() === y.toDateString()) return 'вчера';
    return d.getDate() + '.' + (d.getMonth()+1).toString().padStart(2,'0');
}

function escapeHtml(text) {
    var d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

var VERIFIED_IDS = ['51696863'];

function isVerified(numericId) {
    return VERIFIED_IDS.indexOf(String(numericId)) !== -1;
}

function verifiedBadge(size) {
    var cls = size === 'sm' ? 'verified-badge verified-sm' : size === 'lg' ? 'verified-badge verified-lg' : 'verified-badge';
    return '<span class="' + cls + '"><svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4"/><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.27 5.82 22 7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>';
}

function verifiedBadgeForId(numericId, size) {
    if (!isVerified(numericId)) return '';
    return verifiedBadge(size);
}

var chatsLoaded = false;

function loadCachedConversations() {
    try {
        var d = localStorage.getItem('messenger-convos');
        if (d) { var c = JSON.parse(d); if (c && typeof c === 'object') { conversations = c; renderChatList(); return true; } }
    } catch(e) {}
    return false;
}

function saveCachedConversations() {
    try { localStorage.setItem('messenger-convos', JSON.stringify(conversations)); } catch(e) {}
}

function clearCachedConversations() {
    try { localStorage.removeItem('messenger-convos'); } catch(e) {}
}

async function loadConversations() {
    if (!profile.id) return;
    var loading = document.getElementById('chatsLoading');
    var empty = document.getElementById('chatsEmptyState');
    if (!chatsLoaded) {
        var hasCached = loadCachedConversations();
        if (!hasCached) {
            if (loading) loading.style.display = '';
            if (empty) empty.style.display = 'none';
        }
    }
    try {
        var r1 = await sb.from('messages').select('*').eq('sender_id', profile.id).order('created_at', {ascending:false}).limit(200);
        var r2 = await sb.from('messages').select('*').eq('receiver_id', profile.id).order('created_at', {ascending:false}).limit(200);
        var all = [];
        if (r1.data) all = all.concat(r1.data);
        if (r2.data) all = all.concat(r2.data);
        all.sort(function(a,b){ return new Date(b.created_at) - new Date(a.created_at); });
        var convos = {};
        all.forEach(function(msg){
            var pid = msg.sender_id === profile.id ? msg.receiver_id : msg.sender_id;
            if (!convos[pid]) {
                convos[pid] = { partnerId:pid, lastMessage:msg.content, lastTime:msg.created_at, unread:0, name:'', surname:'', avatarUrl:'' };
            }
            if (msg.receiver_id === profile.id && !msg.read) convos[pid].unread++;
        });
        var pids = Object.keys(convos);
        if (pids.length > 0) {
            var pr = await sb.from('profiles').select('id,name,surname,avatar_url,numeric_id').in('id', pids);
            if (pr.data) pr.data.forEach(function(p){
                if (convos[p.id]) { convos[p.id].name = p.name||'Пользователь'; convos[p.id].surname = p.surname||''; convos[p.id].avatarUrl = p.avatar_url||''; convos[p.id].numericId = p.numeric_id||''; }
            });
        }
        conversations = convos;
        chatsLoaded = true;
        if (loading) loading.style.display = 'none';
        saveCachedConversations();
        renderChatList();
    } catch(e){
        if (loading) loading.style.display = 'none';
        renderChatList();
    }
}

function renderChatList() {
    var list = document.getElementById('chatList');
    var empty = document.getElementById('chatsEmptyState');
    var loading = document.getElementById('chatsLoading');
    var si = document.getElementById('chatSearchInput');
    if (si && si.value.trim()) { list.innerHTML = ''; if (empty) empty.style.display = 'none'; if (loading) loading.style.display = 'none'; return; }
    var keys = Object.keys(conversations);
    keys.sort(function(a,b){ return new Date(conversations[b].lastTime) - new Date(conversations[a].lastTime); });
    var hasMessages = keys.some(function(k){ return conversations[k].lastMessage; });
    if (!hasMessages) { list.innerHTML = ''; if (chatsLoaded) { if (empty) empty.style.display = ''; } return; }
    if (empty) empty.style.display = 'none';
    if (loading) loading.style.display = 'none';
    var html = '';
    keys.forEach(function(pid){
        var c = conversations[pid];
        var fn = c.name||'Пользователь';
        if (c.surname) fn += ' ' + c.surname;
        var l = (c.name||'U').charAt(0).toUpperCase();
        var av = c.avatarUrl ? '<div class="chat-item-ava"><img src="'+c.avatarUrl+'"></div>' : '<div class="chat-item-ava">'+l+'</div>';
        var badge = c.unread > 0 ? '<div class="chat-item-badge">'+c.unread+'</div>' : '';
        var lm = c.lastMessage||'';
        if (lm.length > 30) lm = lm.slice(0,30)+'...';
        var tm = c.lastTime ? formatMsgTime(c.lastTime) : '';
        var chatVerified = verifiedBadgeForId(c.numericId, 'sm');
        html += '<div class="chat-item" onclick="openChatWith(\''+pid+'\',\''+fn.replace(/'/g,"\\'")+'\',\''+l+'\',\''+(c.avatarUrl||'').replace(/'/g,"\\'")+'\')">'
            +av+'<div class="chat-item-info"><div class="chat-item-name">'+escapeHtml(fn)+chatVerified+'</div><div class="chat-item-last">'+escapeHtml(lm)+'</div></div>'
            +'<div class="chat-item-meta"><div class="chat-item-time">'+tm+'</div>'+badge+'</div></div>';
    });
    list.innerHTML = html;
}

function openChatWith(userId, name, letter, avatarUrl) {
    var si = document.getElementById('chatSearchInput');
    if (si) si.value = '';
    var sr = document.getElementById('searchResults');
    if (sr) sr.innerHTML = '';
    lastSearchQuery = '';
    currentChatUserId = userId;
    var chatPartnerNumId = conversations[userId] ? conversations[userId].numericId : '';
    document.getElementById('cName').innerHTML = escapeHtml(name) + verifiedBadgeForId(chatPartnerNumId, 'sm');
    if (avatarUrl) {
        document.getElementById('cAvatar').innerHTML = '<img src="'+avatarUrl+'">';
    } else {
        document.getElementById('cAvatar').textContent = letter;
    }
    document.getElementById('msgInput').value = '';
    document.getElementById('chatScreen').classList.add('active');
    if (!conversations[userId]) {
        var parts = name.split(' ');
        conversations[userId] = { partnerId:userId, name:parts[0]||'Пользователь', surname:parts.slice(1).join(' ')||'', avatarUrl:avatarUrl||'', lastMessage:'', lastTime:'', unread:0 };
    } else {
        conversations[userId].unread = 0;
    }
    renderChatList();
    loadMessages(userId);
    markAsRead(userId);
}

async function loadMessages(partnerId) {
    var mc = document.getElementById('msgs');
    mc.innerHTML = '<div class="search-status">Загрузка...</div>';
    try {
        var res = await sb.from('messages').select('*')
            .or('and(sender_id.eq.'+profile.id+',receiver_id.eq.'+partnerId+'),and(sender_id.eq.'+partnerId+',receiver_id.eq.'+profile.id+')')
            .order('created_at', {ascending:true}).limit(500);
        if (res.data && res.data.length > 0) {
            renderMessages(res.data);
        } else {
            mc.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></div><div class="empty-title">Нет сообщений</div><div class="empty-desc">Напишите первое сообщение, чтобы начать диалог</div></div>';
        }
    } catch(e) {
        mc.innerHTML = '<div class="search-status">Ошибка загрузки сообщений</div>';
    }
}

function renderMessages(messages) {
    var mc = document.getElementById('msgs');
    var html = '';
    messages.forEach(function(msg){
        var isOut = msg.sender_id === profile.id;
        html += '<div class="msg '+(isOut?'out':'in')+'"><div>'+escapeHtml(msg.content)+'</div><div class="msg-time">'+formatMsgTime(msg.created_at)+'</div></div>';
    });
    mc.innerHTML = html;
    mc.scrollTop = mc.scrollHeight;
}

function addMessageToChat(msg) {
    var mc = document.getElementById('msgs');
    var es = mc.querySelector('.empty-state');
    if (es) es.remove();
    var ss = mc.querySelector('.search-status');
    if (ss) ss.remove();
    var isOut = msg.sender_id === profile.id;
    var div = document.createElement('div');
    div.className = 'msg '+(isOut?'out':'in');
    div.innerHTML = '<div>'+escapeHtml(msg.content)+'</div><div class="msg-time">'+formatMsgTime(msg.created_at)+'</div>';
    mc.appendChild(div);
    mc.scrollTop = mc.scrollHeight;
}

async function sendMessage() {
    var inp = document.getElementById('msgInput');
    var text = inp.value.trim();
    if (!text || !currentChatUserId || !profile.id) return;
    if (text.length > 2000) { showToast('Сообщение слишком длинное','error'); return; }
    inp.value = '';
    var partnerId = currentChatUserId;
    var now = new Date().toISOString();
    var tempMsg = { sender_id:profile.id, receiver_id:partnerId, content:text, created_at:now, id:'temp-'+Date.now() };
    addMessageToChat(tempMsg);
    if (!conversations[partnerId]) {
        conversations[partnerId] = { partnerId:partnerId, lastMessage:text, lastTime:now, unread:0, name:'Пользователь', surname:'', avatarUrl:'' };
    } else {
        conversations[partnerId].lastMessage = text;
        conversations[partnerId].lastTime = now;
    }
    saveCachedConversations();
    renderChatList();
    try {
        var res = await sb.from('messages').insert({ sender_id:profile.id, receiver_id:partnerId, content:text }).select().single();
        if (res.error) { showToast('Ошибка отправки','error'); inp.value = text; return; }
    } catch(e) { showToast('Ошибка соединения','error'); inp.value = text; }
}

async function markAsRead(partnerId) {
    if (conversations[partnerId]) { conversations[partnerId].unread = 0; renderChatList(); }
    try {
        await sb.from('messages').update({read:true}).eq('sender_id',partnerId).eq('receiver_id',profile.id).eq('read',false);
    } catch(e){}
}

var processedMsgIds = {};

function handleNewMessage(payload) {
    var msg = payload.new;
    if (!msg || !msg.id) return;
    if (processedMsgIds[msg.id]) return;
    processedMsgIds[msg.id] = true;
    setTimeout(function(){ delete processedMsgIds[msg.id]; }, 30000);
    if (msg.sender_id === profile.id) {
        var pid = msg.receiver_id;
        if (!conversations[pid]) {
            conversations[pid] = { partnerId:pid, lastMessage:msg.content, lastTime:msg.created_at, unread:0, name:'Пользователь', surname:'', avatarUrl:'' };
            sb.from('profiles').select('id,name,surname,avatar_url').eq('id',pid).maybeSingle().then(function(r){
                if (r.data) { conversations[pid].name = r.data.name||'Пользователь'; conversations[pid].surname = r.data.surname||''; conversations[pid].avatarUrl = r.data.avatar_url||''; renderChatList(); }
            });
        } else {
            conversations[pid].lastMessage = msg.content;
            conversations[pid].lastTime = msg.created_at;
        }
        renderChatList();
        return;
    }
    var pid = msg.sender_id;
    if (!conversations[pid]) {
        conversations[pid] = { partnerId:pid, lastMessage:msg.content, lastTime:msg.created_at, unread:0, name:'Пользователь', surname:'', avatarUrl:'' };
        sb.from('profiles').select('id,name,surname,avatar_url').eq('id',pid).maybeSingle().then(function(r){
            if (r.data) { conversations[pid].name = r.data.name||'Пользователь'; conversations[pid].surname = r.data.surname||''; conversations[pid].avatarUrl = r.data.avatar_url||''; renderChatList(); }
        });
    } else {
        conversations[pid].lastMessage = msg.content;
        conversations[pid].lastTime = msg.created_at;
    }
    if (currentChatUserId === pid) {
        addMessageToChat(msg);
        markAsRead(pid);
    } else {
        conversations[pid].unread = (conversations[pid].unread||0) + 1;
    }
    saveCachedConversations();
    renderChatList();
}

function subscribeToMessages() {
    if (messagesChannel) sb.removeChannel(messagesChannel);
    if (!profile.id) return;
    messagesChannel = sb.channel('msgs-'+profile.id)
        .on('postgres_changes', {event:'INSERT',schema:'public',table:'messages',filter:'receiver_id=eq.'+profile.id}, handleNewMessage)
        .on('postgres_changes', {event:'INSERT',schema:'public',table:'messages',filter:'sender_id=eq.'+profile.id}, handleNewMessage)
        .subscribe();
}

function unsubscribeFromMessages() {
    if (messagesChannel) { sb.removeChannel(messagesChannel); messagesChannel = null; }
}

var pendingPostImage = null;

function openCreatePost() {
    if (!profile.username) { showToast('Для публикации установите имя пользователя в профиле', 'warning'); return; }
    document.getElementById('postText').value = '';
    document.getElementById('postImagePreview').style.display = 'none';
    document.getElementById('postImageInput').value = '';
    pendingPostImage = null;
    document.getElementById('createPostScreen').classList.add('active');
}

function closeCreatePost() {
    pendingPostImage = null;
    var s = document.getElementById('createPostScreen');
    s.style.transform = 'translateX(100%)';
    s.style.transition = 'transform .2s ease';
    setTimeout(function() { s.classList.remove('active'); s.style.transform = ''; s.style.transition = ''; }, 200);
}

function previewPostImage(e) {
    var file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { showToast('Выберите изображение', 'error'); return; }
    if (file.size > 5 * 1024 * 1024) { showToast('Максимум 5 МБ', 'error'); return; }
    pendingPostImage = file;
    var reader = new FileReader();
    reader.onload = function(ev) {
        document.getElementById('postImagePreviewImg').src = ev.target.result;
        document.getElementById('postImagePreview').style.display = 'block';
    };
    reader.onerror = function() { showToast('Ошибка чтения файла', 'error'); };
    reader.readAsDataURL(file);
}

function removePostImage() {
    pendingPostImage = null;
    document.getElementById('postImagePreview').style.display = 'none';
    document.getElementById('postImageInput').value = '';
}

async function publishPost() {
    var text = document.getElementById('postText').value.trim();
    if (!text && !pendingPostImage) { showToast('Напишите текст или добавьте фото', 'warning'); return; }
    if (text.length > 500) { showToast('Максимум 500 символов', 'error'); return; }
    var btn = document.getElementById('publishBtn');
    setLoading(btn, true);
    try {
        var imageUrl = null;
        if (pendingPostImage) {
            var ext = pendingPostImage.name.split('.').pop() || 'jpg';
            var path = profile.id + '/' + Date.now() + '.' + ext;
            var res = await sb.storage.from('posts').upload(path, pendingPostImage, { contentType: pendingPostImage.type });
            if (res.error) { showToast('Ошибка загрузки фото', 'error'); setLoading(btn, false); return; }
            var urlRes = sb.storage.from('posts').getPublicUrl(path);
            imageUrl = urlRes.data.publicUrl;
        }
        var postData = { user_id: profile.id, content: text || null, image_url: imageUrl };
        var result = await sb.from('posts').insert(postData);
        if (result.error) { showToast('Ошибка публикации', 'error'); setLoading(btn, false); return; }
        pendingPostImage = null;
        closeCreatePost();
        showToast('Опубликовано');
        cachedPostsHtml = '';
        loadPosts();
    } catch (err) { showToast('Ошибка соединения', 'error'); }
    setLoading(btn, false);
}

var cachedPostsHtml = '';
var postsRefreshInterval = null;

function startPostsAutoRefresh() {
    if (postsRefreshInterval) clearInterval(postsRefreshInterval);
    postsRefreshInterval = setInterval(function() {
        var homePane = document.getElementById('paneHome');
        if (homePane && homePane.classList.contains('active')) {
            loadPosts(true);
        }
    }, 15000);
}

function updatePostCount(posts) {
    var count = 0;
    if (posts && profile.id) {
        posts.forEach(function(p) { if (p.user_id === profile.id) count++; });
    }
    var el = document.getElementById('postCount');
    if (el) el.textContent = count;
}

async function loadPosts(silent) {
    var container = document.getElementById('postsContainer');
    var empty = document.getElementById('postsEmpty');
    var loading = document.getElementById('postsLoading');
    if (!container) return;
    if (!silent && cachedPostsHtml) {
        container.innerHTML = cachedPostsHtml;
        if (empty) empty.style.display = 'none';
    }
    try {
        var res = await sb.from('posts').select('*, profiles(id, name, surname, username, avatar_url, numeric_id)').order('created_at', { ascending: false }).limit(50);
        if (loading) loading.style.display = 'none';
        if (!res.data || res.data.length === 0) { container.innerHTML = ''; cachedPostsHtml = ''; updatePostCount([]); if (empty) empty.style.display = ''; return; }
        if (empty) empty.style.display = 'none';
        var html = '';
        res.data.forEach(function(post) {
            var p = post.profiles || {};
            var fullName = p.name || 'Пользователь';
            if (p.surname) fullName += ' ' + p.surname;
            var letter = (p.name || 'U').charAt(0).toUpperCase();
            var avaHtml = p.avatar_url ? '<div class="post-ava"><img src="' + p.avatar_url + '"></div>' : '<div class="post-ava">' + letter + '</div>';
            var imageHtml = post.image_url ? '<div class="post-image"><img src="' + post.image_url + '"></div>' : '';
            var textHtml = post.content ? '<div class="post-text">' + escapeHtml(post.content) + '</div>' : '';
            var time = formatMsgTime(post.created_at);
            var deleteHtml = post.user_id === profile.id ? '<button class="post-delete" onclick="deletePost(\'' + post.id + '\')"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>' : '';
            var postNumericId = p.numeric_id || (post.user_id === profile.id ? profile.numeric_id : '');
            var postVerified = verifiedBadgeForId(postNumericId, 'sm');
            var metaLine = '';
            metaLine += '<span class="post-author-username">@' + p.username + '</span>';
            metaLine += '<span class="post-time">· ' + time + '</span>';
            html += '<div class="post-card">' + deleteHtml + '<div class="post-header">' + avaHtml + '<div class="post-author"><div class="post-author-name">' + escapeHtml(fullName) + postVerified + '</div><div class="post-author-meta">' + metaLine + '</div></div></div>' + textHtml + imageHtml + '</div>';
        });
        cachedPostsHtml = html;
        container.innerHTML = html;
        updatePostCount(res.data);
    } catch (err) {
        if (loading) loading.style.display = 'none';
        if (!cachedPostsHtml) container.innerHTML = '<div class="search-status">Ошибка загрузки</div>';
    }
}

async function deletePost(postId) {
    if (!postId || !profile.id) return;
    try {
        var res = await sb.from('posts').delete().eq('id', postId).eq('user_id', profile.id);
        if (res.error) { showToast('Ошибка удаления', 'error'); return; }
        loadPosts();
    } catch (err) { showToast('Ошибка соединения', 'error'); }
}

var _origSendMessage = sendMessage;
sendMessage = async function() {
    if (!profile.username) { showToast('Для отправки сообщений установите имя пользователя', 'warning'); return; }
    return _origSendMessage();
};

var _origOpenChatWith = openChatWith;
openChatWith = function(userId, name, letter, avatarUrl) {
    if (!profile.username) { showToast('Для общения установите имя пользователя в профиле', 'warning'); return; }
    return _origOpenChatWith(userId, name, letter, avatarUrl);
};

var _origSwitchTab = switchTab;
switchTab = function(t, el) {
    _origSwitchTab(t, el);
    var fab = document.getElementById('fabBtn');
    if (fab) fab.style.display = t === 'home' ? '' : 'none';
    if (t === 'home') loadPosts();
};



init();
if (profile.id) {
    setTimeout(loadPosts, 300);
    startPostsAutoRefresh();
}
</script>
</body>
</html>
